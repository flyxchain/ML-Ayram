<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ML-Ayram Dashboard</title>
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg:      #0d1117;
    --surface: #161b22;
    --border:  #30363d;
    --text:    #e6edf3;
    --muted:   #8b949e;
    --green:   #3fb950;
    --red:     #f85149;
    --blue:    #58a6ff;
    --yellow:  #d29922;
    --purple:  #bc8cff;
    --radius:  8px;
    --nav-h:   56px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 14px; }

  nav { height: var(--nav-h); background: var(--surface); border-bottom: 1px solid var(--border);
        display: flex; align-items: center; padding: 0 24px; gap: 32px; position: sticky; top: 0; z-index: 100; }
  .nav-brand { font-weight: 700; font-size: 16px; color: var(--blue); letter-spacing: .5px; }
  .nav-links { display: flex; gap: 4px; }
  .nav-link { padding: 6px 14px; border-radius: var(--radius); cursor: pointer; color: var(--muted);
              border: none; background: none; font-size: 14px; transition: all .15s; }
  .nav-link:hover { color: var(--text); background: var(--border); }
  .nav-link.active { color: var(--text); background: #21262d; }
  .nav-status { margin-left: auto; display: flex; align-items: center; gap: 8px; color: var(--muted); font-size: 13px; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

  .page { display: none; padding: 24px; max-width: 1400px; margin: 0 auto; }
  .page.active { display: block; }

  .grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 24px; }
  .grid-3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 16px; margin-bottom: 24px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
  .card-title { font-size: 12px; text-transform: uppercase; letter-spacing: .8px; color: var(--muted); margin-bottom: 8px; }
  .card-value { font-size: 28px; font-weight: 700; }
  .card-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .green  { color: var(--green); }
  .red    { color: var(--red); }
  .blue   { color: var(--blue); }
  .yellow { color: var(--yellow); }
  .purple { color: var(--purple); }

  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .section-title { font-size: 16px; font-weight: 600; }

  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 10px 12px; color: var(--muted); font-weight: 500;
       border-bottom: 1px solid var(--border); white-space: nowrap; }
  td { padding: 10px 12px; border-bottom: 1px solid #21262d; white-space: nowrap; }
  tr:hover td { background: #21262d44; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .badge-long  { background: #3fb95022; color: var(--green); border: 1px solid #3fb95044; }
  .badge-short { background: #f8514922; color: var(--red);   border: 1px solid #f8514944; }
  .badge-neut  { background: #8b949e22; color: var(--muted); border: 1px solid #8b949e44; }
  .badge-tp    { background: #3fb95022; color: var(--green); border: 1px solid #3fb95044; }
  .badge-sl    { background: #f8514922; color: var(--red);   border: 1px solid #f8514944; }
  .conf-bar  { width: 60px; height: 6px; background: var(--border); border-radius: 3px; display: inline-block; vertical-align: middle; overflow: hidden; }
  .conf-fill { height: 100%; background: var(--blue); border-radius: 3px; }

  #chart-container { height: 480px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .chart-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  select, input[type=number] {
    background: var(--surface); border: 1px solid var(--border); color: var(--text);
    border-radius: var(--radius); padding: 6px 10px; font-size: 13px; outline: none; }
  select:focus, input:focus { border-color: var(--blue); }

  .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .field { display: flex; flex-direction: column; gap: 6px; }
  .field label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
  .field input[type=number] { width: 100%; }
  .field-toggle { display: flex; align-items: center; gap: 10px; }
  .toggle { width: 40px; height: 22px; background: var(--border); border-radius: 11px; position: relative; cursor: pointer; transition: background .2s; }
  .toggle.on { background: var(--green); }
  .toggle::after { content:''; position: absolute; top: 3px; left: 3px; width: 16px; height: 16px;
                   border-radius: 50%; background: white; transition: left .2s; }
  .toggle.on::after { left: 21px; }
  .btn { padding: 8px 18px; border-radius: var(--radius); border: none; cursor: pointer;
         font-size: 14px; font-weight: 500; transition: opacity .15s; }
  .btn-primary { background: var(--blue); color: #0d1117; }
  .btn-primary:hover { opacity: .85; }
  .btn-ghost { background: var(--border); color: var(--text); }
  .btn-ghost:hover { opacity: .85; }
  .save-msg { font-size: 12px; color: var(--green); display: none; }

  .pagination { display: flex; gap: 8px; align-items: center; margin-top: 16px; }
  .page-btn { padding: 4px 10px; border-radius: 4px; border: 1px solid var(--border);
              background: none; color: var(--text); cursor: pointer; }
  .page-btn:disabled { opacity: .3; cursor: default; }
  .page-info { color: var(--muted); font-size: 13px; }

  .filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
  .chart-sm { height: 220px; }
  .empty-state { padding: 48px; text-align: center; color: var(--muted); font-size: 15px; }
  .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border);
             border-top-color: var(--blue); border-radius: 50%; animation: spin .7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .pnl-pos { color: var(--green); font-weight: 600; }
  .pnl-neg { color: var(--red);   font-weight: 600; }

  @media(max-width:900px) {
    .grid-4,.grid-3 { grid-template-columns: 1fr 1fr; }
    .config-grid,.grid-2 { grid-template-columns: 1fr; }
  }
  @media(max-width:500px) {
    .grid-4,.grid-3 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<nav>
  <span class="nav-brand">ğŸ“ˆ ML-Ayram</span>
  <div class="nav-links">
    <button class="nav-link active"  onclick="showPage('dashboard',this)">Dashboard</button>
    <button class="nav-link"         onclick="showPage('chart',this)">GrÃ¡fico</button>
    <button class="nav-link"         onclick="showPage('history',this)">Historial</button>
    <button class="nav-link"         onclick="showPage('metrics',this)">MÃ©tricas</button>
    <button class="nav-link"         onclick="showPage('performance',this)">Rendimiento</button>
    <button class="nav-link"         onclick="showPage('monitor',this)">Monitor</button>
    <button class="nav-link"         onclick="showPage('config',this)">ConfiguraciÃ³n</button>
  </div>
  <div class="nav-status">
    <div class="dot" id="status-dot"></div>
    <span id="status-text">Conectandoâ€¦</span>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â• -->
<div id="page-dashboard" class="page active">
  <div class="grid-4">
    <div class="card">
      <div class="card-title">SeÃ±ales hoy</div>
      <div class="card-value blue" id="kpi-today">â€”</div>
      <div class="card-sub">vÃ¡lidas (UTC)</div>
    </div>
    <div class="card">
      <div class="card-title">Ãšltima seÃ±al</div>
      <div class="card-value" id="kpi-last-dir">â€”</div>
      <div class="card-sub" id="kpi-last-ts">â€”</div>
    </div>
    <div class="card">
      <div class="card-title">Posiciones abiertas</div>
      <div class="card-value yellow" id="kpi-positions">â€”</div>
      <div class="card-sub" id="kpi-positions-pnl">PnL flotante: â€”</div>
    </div>
    <div class="card">
      <div class="card-title">Velas en BD</div>
      <div class="card-value purple" id="kpi-bars">â€”</div>
      <div class="card-sub">OHLCV raw</div>
    </div>
  </div>

  <!-- Posiciones abiertas -->
  <div class="card" style="margin-bottom:16px" id="positions-card">
    <div class="section-header">
      <span class="section-title">Posiciones abiertas</span>
      <button class="btn btn-ghost" onclick="loadDashboard()">â†» Actualizar</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Par</th><th>TF</th><th>DirecciÃ³n</th><th>Entrada</th>
            <th>Precio actual</th><th>TP</th><th>SL</th><th>Lotes</th>
            <th>Riesgo â‚¬</th><th>PnL flotante</th><th>Abierto</th>
          </tr>
        </thead>
        <tbody id="positions-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Ãšltimas seÃ±ales -->
  <div class="card">
    <div class="section-header">
      <span class="section-title">SeÃ±ales recientes</span>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Hora (UTC)</th><th>Par</th><th>TF</th><th>DirecciÃ³n</th>
            <th>Entrada</th><th>TP</th><th>SL</th><th>R:R</th>
            <th>Confianza</th><th>ADX</th><th>SesiÃ³n</th><th>Estado</th>
          </tr>
        </thead>
        <tbody id="latest-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• GRÃFICO â•â•â•â•â•â•â•â•â•â• -->
<div id="page-chart" class="page">
  <div class="card" style="margin-bottom:16px">
    <div class="chart-controls">
      <select id="chart-pair">
        <option>EURUSD</option><option>GBPUSD</option>
        <option>USDJPY</option><option>EURJPY</option><option>XAUUSD</option>
      </select>
      <select id="chart-tf">
        <option>M15</option><option value="H1" selected>H1</option>
        <option>H4</option><option>D1</option>
      </select>
      <select id="chart-bars">
        <option value="100">100 velas</option>
        <option value="200" selected>200 velas</option>
        <option value="500">500 velas</option>
      </select>
      <button class="btn btn-primary" onclick="loadChart()">Cargar</button>
      <label style="display:flex;align-items:center;gap:6px;color:var(--muted)">
        <input type="checkbox" id="show-signals" checked> SeÃ±ales
      </label>
    </div>
  </div>
  <div id="chart-container"></div>
  <div style="padding:12px 0;color:var(--muted);font-size:12px">
    ğŸŸ¢ SeÃ±al LONG &nbsp;|&nbsp; ğŸ”´ SeÃ±al SHORT &nbsp;|&nbsp; LÃ­neas punteadas: TP (verde) / SL (rojo)
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• HISTORIAL â•â•â•â•â•â•â•â•â•â• -->
<div id="page-history" class="page">
  <div class="filters">
    <select id="hist-pair"><option value="">Todos los pares</option>
      <option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>EURJPY</option><option>XAUUSD</option></select>
    <select id="hist-tf"><option value="">Todos TF</option>
      <option>M15</option><option>H1</option><option>H4</option></select>
    <select id="hist-dir"><option value="">Todas</option>
      <option value="1">LONG</option><option value="-1">SHORT</option></select>
    <select id="hist-days">
      <option value="7">7 dÃ­as</option><option value="30" selected>30 dÃ­as</option>
      <option value="90">90 dÃ­as</option><option value="365">1 aÃ±o</option></select>
    <button class="btn btn-primary" onclick="loadHistory(1)">Filtrar</button>
  </div>
  <div class="card">
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Hora (UTC)</th><th>Par</th><th>TF</th><th>DirecciÃ³n</th>
          <th>Entrada</th><th>TP</th><th>SL</th><th>R:R</th>
          <th>TP pips</th><th>SL pips</th><th>Confianza</th>
          <th>XGB</th><th>LSTM</th><th>ADX</th><th>SesiÃ³n</th>
        </tr></thead>
        <tbody id="hist-tbody"></tbody>
      </table>
    </div>
    <div class="pagination">
      <button class="page-btn" id="hist-prev" onclick="histPage(-1)">â€¹ Anterior</button>
      <span class="page-info" id="hist-page-info"></span>
      <button class="page-btn" id="hist-next" onclick="histPage(1)">Siguiente â€º</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• MÃ‰TRICAS â•â•â•â•â•â•â•â•â•â• -->
<div id="page-metrics" class="page">
  <div class="filters">
    <select id="met-pair"><option value="">Todos los pares</option>
      <option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>EURJPY</option><option>XAUUSD</option></select>
    <select id="met-tf"><option value="">Todos TF</option>
      <option>M15</option><option>H1</option><option>H4</option></select>
    <select id="met-days">
      <option value="30">30 dÃ­as</option><option value="90" selected>90 dÃ­as</option>
      <option value="180">180 dÃ­as</option><option value="365">1 aÃ±o</option></select>
    <button class="btn btn-primary" onclick="loadMetrics()">Aplicar</button>
  </div>
  <div class="grid-4">
    <div class="card"><div class="card-title">Total seÃ±ales</div><div class="card-value blue" id="m-total">â€”</div></div>
    <div class="card"><div class="card-title">Conf. promedio</div><div class="card-value green" id="m-conf">â€”</div></div>
    <div class="card"><div class="card-title">R:R promedio</div><div class="card-value yellow" id="m-rr">â€”</div></div>
    <div class="card"><div class="card-title">Acuerdo modelos</div><div class="card-value purple" id="m-agree">â€”</div></div>
  </div>
  <div class="grid-2">
    <div class="card">
      <div class="section-title" style="margin-bottom:14px">DistribuciÃ³n Long / Short</div>
      <div class="chart-sm"><canvas id="chart-dir"></canvas></div>
    </div>
    <div class="card">
      <div class="section-title" style="margin-bottom:14px">SeÃ±ales por par</div>
      <div class="chart-sm"><canvas id="chart-pairs"></canvas></div>
    </div>
  </div>
  <div class="card">
    <div class="section-title" style="margin-bottom:14px">SeÃ±ales por dÃ­a (Ãºltimos 30 dÃ­as)</div>
    <div style="height:200px"><canvas id="chart-daily"></canvas></div>
  </div>
  <div class="grid-2" style="margin-top:16px">
    <div class="card">
      <div class="section-title" style="margin-bottom:14px">SeÃ±ales por timeframe</div>
      <div class="chart-sm"><canvas id="chart-tf-dist"></canvas></div>
    </div>
    <div class="card">
      <div class="section-title" style="margin-bottom:14px">Long vs Short por par</div>
      <div class="chart-sm"><canvas id="chart-pair-dir"></canvas></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• RENDIMIENTO â•â•â•â•â•â•â•â•â•â• -->
<div id="page-performance" class="page">
  <div class="filters">
    <select id="perf-pair"><option value="">Todos los pares</option>
      <option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>EURJPY</option><option>XAUUSD</option></select>
    <select id="perf-tf"><option value="">Todos TF</option>
      <option>M15</option><option>H1</option><option>H4</option></select>
    <select id="perf-days">
      <option value="7">7 dÃ­as</option><option value="30" selected>30 dÃ­as</option>
      <option value="90">90 dÃ­as</option><option value="365">Todo</option></select>
    <button class="btn btn-primary" onclick="loadPerformance()">Aplicar</button>
  </div>

  <div id="perf-empty" class="card empty-state" style="display:none">
    ğŸ“Š AÃºn no hay trades cerrados. Los resultados aparecerÃ¡n cuando el position manager cierre la primera posiciÃ³n.
  </div>

  <div id="perf-content">
    <!-- KPIs -->
    <div class="grid-4">
      <div class="card"><div class="card-title">PnL total</div><div class="card-value" id="p-pnl">â€”</div><div class="card-sub" id="p-trades">â€” trades</div></div>
      <div class="card"><div class="card-title">Win rate</div><div class="card-value green" id="p-wr">â€”</div><div class="card-sub" id="p-wl">â€” / â€”</div></div>
      <div class="card"><div class="card-title">Profit factor</div><div class="card-value blue" id="p-pf">â€”</div><div class="card-sub">ganancia / pÃ©rdida bruta</div></div>
      <div class="card"><div class="card-title">Max drawdown</div><div class="card-value red" id="p-dd">â€”</div><div class="card-sub">desde mÃ¡ximo</div></div>
    </div>
    <div class="grid-3">
      <div class="card"><div class="card-title">Trade ganador medio</div><div class="card-value green" id="p-avgwin">â€”</div></div>
      <div class="card"><div class="card-title">Trade perdedor medio</div><div class="card-value red" id="p-avgloss">â€”</div></div>
      <div class="card"><div class="card-title">DuraciÃ³n media</div><div class="card-value yellow" id="p-dur">â€”</div><div class="card-sub">velas</div></div>
    </div>

    <!-- Equity curve -->
    <div class="card" style="margin-bottom:16px">
      <div class="section-title" style="margin-bottom:14px">Curva de equity</div>
      <div style="height:240px"><canvas id="chart-equity"></canvas></div>
    </div>

    <!-- Breakdown por par -->
    <div class="grid-2">
      <div class="card">
        <div class="section-title" style="margin-bottom:14px">Rendimiento por par</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Par</th><th>Trades</th><th>Win %</th><th>PnL â‚¬</th></tr></thead>
            <tbody id="perf-pairs-tbody"></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="section-title" style="margin-bottom:14px">Ãšltimos 10 trades</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Par</th><th>TF</th><th>Dir</th><th>Resultado</th><th>PnL â‚¬</th><th>Velas</th></tr></thead>
            <tbody id="perf-recent-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• MONITOR â•â•â•â•â•â•â•â•â•â• -->
<div id="page-monitor" class="page">
  <div class="section-header" style="margin-bottom:16px">
    <span class="section-title">ğŸ“¶ Monitor de datos</span>
    <div style="display:flex;gap:10px;align-items:center">
      <span id="mon-server-time" style="color:var(--muted);font-size:12px"></span>
      <button class="btn btn-ghost" onclick="loadMonitor()">â†» Actualizar</button>
      <label style="display:flex;align-items:center;gap:6px;color:var(--muted);font-size:13px">
        <input type="checkbox" id="mon-auto" checked> Auto 30s
      </label>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid-4">
    <div class="card">
      <div class="card-title">Collector (OHLCV)</div>
      <div class="card-value" id="mon-coll-health">â€”</div>
      <div class="card-sub" id="mon-coll-total">â€” velas en BD</div>
    </div>
    <div class="card">
      <div class="card-title">Features</div>
      <div class="card-value" id="mon-feat-health">â€”</div>
      <div class="card-sub" id="mon-feat-total">â€” features en BD</div>
    </div>
    <div class="card">
      <div class="card-title">Ãšltima vela descargada</div>
      <div class="card-value" style="font-size:16px" id="mon-last-candle">â€”</div>
    </div>
    <div class="card">
      <div class="card-title">Ãšltimo feature calculado</div>
      <div class="card-value" style="font-size:16px" id="mon-last-feature">â€”</div>
    </div>
  </div>

  <!-- Tabla OHLCV -->
  <div class="card" style="margin-bottom:16px">
    <div class="section-header">
      <span class="section-title">ğŸ“Š Datos OHLCV (Collector)</span>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Par</th><th>TF</th><th>Ãšltima vela</th><th>AntigÃ¼edad</th><th>Filas</th><th>Estado</th>
        </tr></thead>
        <tbody id="mon-ohlcv-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Tabla Features -->
  <div class="card">
    <div class="section-header">
      <span class="section-title">âš™ï¸ Features calculados</span>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Par</th><th>TF</th><th>Ãšltimo feature</th><th>AntigÃ¼edad</th><th>Filas</th><th>Estado</th>
        </tr></thead>
        <tbody id="mon-feat-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• CONFIGURACIÃ“N â•â•â•â•â•â•â•â•â•â• -->
<div id="page-config" class="page">
  <div class="card" style="max-width:700px">
    <div class="section-header">
      <span class="section-title">Filtros del generador de seÃ±ales</span>
    </div>
    <p style="color:var(--muted);font-size:13px;margin-bottom:24px">
      ParÃ¡metros aplicados en tiempo real a las nuevas seÃ±ales. El cambio es inmediato y se mantiene mientras el servidor estÃ© activo.
    </p>
    <div class="config-grid">
      <div class="field"><label>Confianza mÃ­nima (%)</label>
        <input type="number" id="cfg-confidence" min="50" max="99" step="1" value="54"></div>
      <div class="field"><label>ADX mÃ­nimo</label>
        <input type="number" id="cfg-adx" min="0" max="100" step="1" value="20"></div>
      <div class="field"><label>R:R mÃ­nimo</label>
        <input type="number" id="cfg-rr" min="1" max="5" step="0.1" value="1.5"></div>
      <div class="field"><label>Cooldown (velas)</label>
        <input type="number" id="cfg-cooldown" min="0" max="20" step="1" value="3"></div>
      <div class="field"><label>Multiplicador TP (Ã— ATR)</label>
        <input type="number" id="cfg-tp" min="1" max="5" step="0.1" value="2.0"></div>
      <div class="field"><label>Multiplicador SL (Ã— ATR)</label>
        <input type="number" id="cfg-sl" min="0.5" max="3" step="0.1" value="1.0"></div>
      <div class="field"><label>Permitir fuera de sesiÃ³n</label>
        <div class="field-toggle">
          <div class="toggle" id="cfg-offmarket" onclick="toggleField('cfg-offmarket')"></div>
          <span id="cfg-offmarket-label" style="color:var(--muted)">No</span>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:12px;align-items:center;margin-top:28px">
      <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ Guardar cambios</button>
      <button class="btn btn-ghost" onclick="loadConfig()">â†» Recargar</button>
      <span class="save-msg" id="save-msg">âœ… Guardado correctamente</span>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• JS â•â•â•â•â•â•â•â•â•â• -->
<script>
let _histCurrentPage = 1;
let _histTotalPages  = 1;
let _chartJsInstances = {};

// â”€â”€ NavegaciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'chart')       loadChart();
  if (name === 'history')     loadHistory(1);
  if (name === 'metrics')     loadMetrics();
  if (name === 'performance') loadPerformance();
  if (name === 'monitor')     loadMonitor();
  if (name === 'config')      loadConfig();
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dirBadge(d) {
  if (d === 1)  return '<span class="badge badge-long">LONG</span>';
  if (d === -1) return '<span class="badge badge-short">SHORT</span>';
  return '<span class="badge badge-neut">NEU</span>';
}
function resultBadge(r) {
  if (r === 'tp_hit') return '<span class="badge badge-tp">TP âœ“</span>';
  if (r === 'sl_hit') return '<span class="badge badge-sl">SL âœ—</span>';
  return `<span class="badge badge-neut">${r}</span>`;
}
function pnlClass(v) { return v >= 0 ? 'pnl-pos' : 'pnl-neg'; }
function confBar(c) {
  const pct = Math.round((c ?? 0) * 100);
  return `<span class="conf-bar"><span class="conf-fill" style="width:${pct}%"></span></span> ${pct}%`;
}
function fmts(ts) {
  if (!ts) return 'â€”';
  return new Date(ts).toLocaleString('es', {timeZone:'UTC', hour12:false}).replace(',','');
}
function fp(n, dec=5) { return n != null ? Number(n).toFixed(dec) : 'â€”'; }
function destroyChart(id) {
  if (_chartJsInstances[id]) { _chartJsInstances[id].destroy(); delete _chartJsInstances[id]; }
}
function mkChart(id, type, labels, datasets, extra={}) {
  destroyChart(id);
  const ctx = document.getElementById(id)?.getContext('2d');
  if (!ctx) return;
  _chartJsInstances[id] = new Chart(ctx, {
    type, data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#e6edf3', font: { size: 12 } } } },
      scales: (type !== 'pie' && type !== 'doughnut') ? {
        x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
        y: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
      } : {},
      ...extra,
    }
  });
}

// â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStatus() {
  try {
    const d = await fetch('/api/status').then(r => r.json());
    document.getElementById('status-text').textContent = 'Online Â· ' + new Date().toLocaleTimeString('es');
    document.getElementById('status-dot').style.background = 'var(--green)';
    document.getElementById('kpi-bars').textContent = d.total_bars?.toLocaleString() ?? 'â€”';
    document.getElementById('kpi-positions').textContent = d.open_positions ?? 'â€”';
  } catch {
    document.getElementById('status-dot').style.background = 'var(--red)';
    document.getElementById('status-text').textContent = 'Sin conexiÃ³n';
  }
}

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  await loadStatus();

  // SeÃ±ales recientes
  const data = await fetch('/api/signals/latest?limit=30').then(r => r.json()).catch(() => []);
  const todayUTC = new Date().toISOString().slice(0, 10);
  const valid = data.filter(s => s.filter_reason == null && s.direction !== 0);
  const today = valid.filter(s => s.timestamp && s.timestamp.startsWith(todayUTC));

  document.getElementById('kpi-today').textContent = today.length;

  if (valid.length) {
    const last = valid[0];
    const el = document.getElementById('kpi-last-dir');
    el.textContent = last.direction === 1 ? 'ğŸŸ¢ LONG' : 'ğŸ”´ SHORT';
    el.className = 'card-value ' + (last.direction === 1 ? 'green' : 'red');
    document.getElementById('kpi-last-ts').textContent = fmts(last.timestamp);
  }

  document.getElementById('latest-tbody').innerHTML = data.map(s => `
    <tr>
      <td>${fmts(s.timestamp)}</td>
      <td><b>${s.pair}</b></td>
      <td>${s.timeframe}</td>
      <td>${dirBadge(s.direction)}</td>
      <td>${fp(s.entry_price)}</td>
      <td class="green">${fp(s.tp_price)}</td>
      <td class="red">${fp(s.sl_price)}</td>
      <td>${s.rr_ratio?.toFixed(2) ?? 'â€”'}</td>
      <td>${confBar(s.confidence)}</td>
      <td>${s.adx?.toFixed(1) ?? 'â€”'}</td>
      <td>${s.session ?? 'â€”'}</td>
      <td>${s.filter_reason
        ? `<span style="color:var(--muted);font-size:11px">${s.filter_reason}</span>`
        : '<span style="color:var(--green)">âœ… VÃ¡lida</span>'}</td>
    </tr>`).join('');

  // Posiciones abiertas
  const positions = await fetch('/api/positions').then(r => r.ok ? r.json() : []).catch(() => []);
  const posArr = Array.isArray(positions) ? positions : [];
  const totalFloat = posArr.reduce((s, p) => s + (p.floating_pnl ?? 0), 0);
  document.getElementById('kpi-positions-pnl').textContent =
    posArr.length ? `PnL flotante: ${totalFloat >= 0 ? '+' : ''}${totalFloat.toFixed(2)}â‚¬` : 'Sin posiciones abiertas';

  document.getElementById('positions-tbody').innerHTML = posArr.length
    ? posArr.map(p => `
        <tr>
          <td><b>${p.pair}</b></td>
          <td>${p.timeframe}</td>
          <td>${dirBadge(p.direction)}</td>
          <td>${fp(p.entry_price)}</td>
          <td>${p.current_price != null ? fp(p.current_price) : 'â€”'}</td>
          <td class="green">${fp(p.tp_price)}</td>
          <td class="red">${fp(p.sl_price)}</td>
          <td>${p.lot_size}</td>
          <td>${p.risk_amount?.toFixed(2)}â‚¬</td>
          <td class="${pnlClass(p.floating_pnl ?? 0)}">${p.floating_pnl != null ? (p.floating_pnl >= 0 ? '+' : '') + p.floating_pnl.toFixed(2) + 'â‚¬' : 'â€”'}</td>
          <td>${fmts(p.opened_at)}</td>
        </tr>`).join('')
    : '<tr><td colspan="11" style="text-align:center;color:var(--muted);padding:20px">Sin posiciones abiertas</td></tr>';
}

// â”€â”€ GrÃ¡fico de velas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadChart() {
  const pair  = document.getElementById('chart-pair').value;
  const tf    = document.getElementById('chart-tf').value;
  const bars  = document.getElementById('chart-bars').value;
  const showSig = document.getElementById('show-signals').checked;
  const container = document.getElementById('chart-container');
  container.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;"><div class="spinner"></div></div>';

  try {
    const d = await fetch(`/api/chart/${pair}/${tf}?bars=${bars}`).then(r => r.json());
    if (d.detail) throw new Error(d.detail);
    container.innerHTML = '';

    const chart = LightweightCharts.createChart(container, {
      width:  container.offsetWidth, height: 480,
      layout: { background: { color: '#161b22' }, textColor: '#e6edf3' },
      grid:   { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
      rightPriceScale: { borderColor: '#30363d' },
      timeScale: { borderColor: '#30363d', timeVisible: true, secondsVisible: false },
    });

    const cs = chart.addCandlestickSeries({
      upColor: '#3fb950', downColor: '#f85149',
      borderUpColor: '#3fb950', borderDownColor: '#f85149',
      wickUpColor: '#3fb950', wickDownColor: '#f85149',
    });
    cs.setData(d.candles.map(c => ({ time: c.timestamp, open: c.open, high: c.high, low: c.low, close: c.close })));

    if (showSig && d.signals.length) {
      cs.setMarkers(d.signals.map(s => ({
        time:     s.timestamp,
        position: s.direction === 1 ? 'belowBar' : 'aboveBar',
        color:    s.direction === 1 ? '#3fb950' : '#f85149',
        shape:    s.direction === 1 ? 'arrowUp' : 'arrowDown',
        text:     `${s.direction === 1 ? 'â–²' : 'â–¼'} ${Number(s.confidence * 100).toFixed(0)}%`,
      })));

      const last = d.signals[d.signals.length - 1];
      if (last) {
        const t1 = d.candles[Math.max(0, d.candles.length - 50)].timestamp;
        const t2 = d.candles[d.candles.length - 1].timestamp;
        const tp = chart.addLineSeries({ color: '#3fb95077', lineWidth: 1, lineStyle: 2 });
        const sl = chart.addLineSeries({ color: '#f8514977', lineWidth: 1, lineStyle: 2 });
        tp.setData([{ time: t1, value: last.tp_price }, { time: t2, value: last.tp_price }]);
        sl.setData([{ time: t1, value: last.sl_price }, { time: t2, value: last.sl_price }]);
      }
    }
    chart.timeScale().fitContent();
    window.addEventListener('resize', () => chart.applyOptions({ width: container.offsetWidth }));
  } catch(e) {
    container.innerHTML = `<div style="padding:24px;color:var(--red)">Error: ${e.message}</div>`;
  }
}

// â”€â”€ Historial â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHistory(page) {
  _histCurrentPage = page;
  const pair = document.getElementById('hist-pair').value;
  const tf   = document.getElementById('hist-tf').value;
  const dir  = document.getElementById('hist-dir').value;
  const days = document.getElementById('hist-days').value;
  let url = `/api/signals/history?page=${page}&page_size=50&days=${days}`;
  if (pair) url += `&pair=${pair}`;
  if (tf)   url += `&timeframe=${tf}`;
  if (dir)  url += `&direction=${dir}`;
  const data = await fetch(url).then(r => r.json());
  _histTotalPages = data.pages;

  document.getElementById('hist-tbody').innerHTML = data.signals.map(s => `
    <tr>
      <td>${fmts(s.timestamp)}</td><td><b>${s.pair}</b></td><td>${s.timeframe}</td>
      <td>${dirBadge(s.direction)}</td>
      <td>${fp(s.entry_price)}</td>
      <td class="green">${fp(s.tp_price)}</td>
      <td class="red">${fp(s.sl_price)}</td>
      <td>${s.rr_ratio?.toFixed(2) ?? 'â€”'}</td>
      <td class="green">+${s.tp_pips?.toFixed(1) ?? 'â€”'}</td>
      <td class="red">-${s.sl_pips?.toFixed(1) ?? 'â€”'}</td>
      <td>${confBar(s.confidence)}</td>
      <td>${dirBadge(s.xgb_direction)}</td>
      <td>${dirBadge(s.lstm_direction)}</td>
      <td>${s.adx?.toFixed(1) ?? 'â€”'}</td>
      <td>${s.session ?? 'â€”'}</td>
    </tr>`).join('');

  document.getElementById('hist-page-info').textContent = `PÃ¡gina ${page} de ${data.pages} (${data.total} seÃ±ales)`;
  document.getElementById('hist-prev').disabled = page <= 1;
  document.getElementById('hist-next').disabled = page >= data.pages;
}
function histPage(d) { loadHistory(_histCurrentPage + d); }

// â”€â”€ MÃ©tricas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMetrics() {
  const pair = document.getElementById('met-pair').value;
  const tf   = document.getElementById('met-tf').value;
  const days = document.getElementById('met-days').value;
  let url = `/api/metrics?days=${days}`;
  if (pair) url += `&pair=${pair}`;
  if (tf)   url += `&timeframe=${tf}`;

  const m = await fetch(url).then(r => r.json());
  if (m.error) {
    ['m-total','m-conf','m-rr','m-agree'].forEach(id => document.getElementById(id).textContent = 'â€”');
    return;
  }

  document.getElementById('m-total').textContent = m.total_signals;
  document.getElementById('m-conf').textContent  = m.avg_confidence + '%';
  document.getElementById('m-rr').textContent    = m.avg_rr;
  document.getElementById('m-agree').textContent = m.agreement_pct + '%';

  mkChart('chart-dir', 'doughnut', ['LONG','SHORT'],
    [{ data: [m.long_signals, m.short_signals], backgroundColor: ['#3fb950','#f85149'] }]);

  mkChart('chart-pairs', 'bar', Object.keys(m.by_pair),
    [{ label:'SeÃ±ales', data: Object.values(m.by_pair), backgroundColor:'#58a6ff88', borderColor:'#58a6ff', borderWidth:1 }]);

  mkChart('chart-daily', 'bar', m.signals_by_day.map(d => d.date),
    [{ label:'SeÃ±ales/dÃ­a', data: m.signals_by_day.map(d => d.count), backgroundColor:'#bc8cff88', borderColor:'#bc8cff', borderWidth:1 }]);

  mkChart('chart-tf-dist', 'doughnut', Object.keys(m.by_timeframe),
    [{ data: Object.values(m.by_timeframe), backgroundColor:['#58a6ff','#3fb950','#f85149'] }]);

  // Long vs Short por par (stacked bar)
  const pairs = Object.keys(m.by_pair);
  mkChart('chart-pair-dir', 'bar', pairs, [
    { label:'LONG',  data: pairs.map(() => Math.round(m.long_pct)),  backgroundColor:'#3fb95088' },
    { label:'SHORT', data: pairs.map(() => Math.round(m.short_pct)), backgroundColor:'#f8514988' },
  ], { scales: { x:{ stacked:true, ticks:{color:'#8b949e'}, grid:{color:'#21262d'} }, y:{ stacked:true, ticks:{color:'#8b949e'}, grid:{color:'#21262d'} } } });
}

// â”€â”€ Rendimiento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPerformance() {
  const pair = document.getElementById('perf-pair').value;
  const tf   = document.getElementById('perf-tf').value;
  const days = document.getElementById('perf-days').value;
  let url = `/api/performance?days=${days}`;
  if (pair) url += `&pair=${pair}`;
  if (tf)   url += `&timeframe=${tf}`;

  const p = await fetch(url).then(r => r.json());

  if (!p.trades || p.trades === 0) {
    document.getElementById('perf-empty').style.display = 'block';
    document.getElementById('perf-content').style.display = 'none';
    return;
  }
  document.getElementById('perf-empty').style.display = 'none';
  document.getElementById('perf-content').style.display = 'block';

  // KPIs
  const pnlEl = document.getElementById('p-pnl');
  pnlEl.textContent = (p.total_pnl >= 0 ? '+' : '') + p.total_pnl.toFixed(2) + 'â‚¬';
  pnlEl.className = 'card-value ' + (p.total_pnl >= 0 ? 'green' : 'red');

  document.getElementById('p-trades').textContent  = `${p.trades} trades`;
  document.getElementById('p-wr').textContent      = p.win_rate + '%';
  document.getElementById('p-wl').textContent      = `${p.wins} âœ“ / ${p.losses} âœ—`;
  document.getElementById('p-pf').textContent      = p.profit_factor === Infinity ? 'âˆ' : p.profit_factor;
  document.getElementById('p-dd').textContent      = p.max_drawdown.toFixed(2) + 'â‚¬';
  document.getElementById('p-avgwin').textContent  = '+' + p.avg_win.toFixed(2) + 'â‚¬';
  document.getElementById('p-avgloss').textContent = p.avg_loss.toFixed(2) + 'â‚¬';
  document.getElementById('p-dur').textContent     = p.avg_duration_bars.toFixed(1);

  // Equity curve
  mkChart('chart-equity', 'line',
    p.equity_curve.map(d => d.date),
    [{
      label: 'Equity (â‚¬)', data: p.equity_curve.map(d => d.cumulative),
      borderColor: '#58a6ff', backgroundColor: '#58a6ff22',
      fill: true, tension: 0.3, pointRadius: 2,
    }]
  );

  // Por par
  document.getElementById('perf-pairs-tbody').innerHTML = p.by_pair.map(row => `
    <tr>
      <td><b>${row.pair}</b></td>
      <td>${row.trades}</td>
      <td>${row.win_rate.toFixed(1)}%</td>
      <td class="${pnlClass(row.pnl)}">${row.pnl >= 0 ? '+' : ''}${row.pnl.toFixed(2)}â‚¬</td>
    </tr>`).join('');

  // Ãšltimos trades
  document.getElementById('perf-recent-tbody').innerHTML = p.recent_trades.map(t => `
    <tr>
      <td><b>${t.pair}</b></td>
      <td>${t.timeframe}</td>
      <td>${dirBadge(t.direction)}</td>
      <td>${resultBadge(t.result)}</td>
      <td class="${pnlClass(t.pnl)}">${t.pnl >= 0 ? '+' : ''}${t.pnl.toFixed(2)}â‚¬</td>
      <td>${t.duration_bars}</td>
    </tr>`).join('');
}

// â”€â”€ Monitor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _monitorInterval = null;

function monStatusBadge(status) {
  const map = {
    ok:       '<span class="badge badge-tp">âœ… OK</span>',
    stale:    '<span class="badge" style="background:#d2992222;color:#d29922;border:1px solid #d2992244">âš ï¸ Retrasado</span>',
    critical: '<span class="badge badge-sl">ğŸ›‘ CrÃ­tico</span>',
    no_data:  '<span class="badge badge-neut">â€” Sin datos</span>',
  };
  return map[status] || status;
}

function ageText(minutes) {
  if (minutes == null) return 'â€”';
  if (minutes < 60)   return Math.round(minutes) + ' min';
  if (minutes < 1440) return (minutes / 60).toFixed(1) + ' h';
  return (minutes / 1440).toFixed(1) + ' d';
}

function ageColor(status) {
  if (status === 'ok')       return 'color:var(--green)';
  if (status === 'stale')    return 'color:var(--yellow)';
  if (status === 'critical') return 'color:var(--red)';
  return 'color:var(--muted)';
}

async function loadMonitor() {
  try {
    const d = await fetch('/api/monitor').then(r => r.json());
    if (d.detail) throw new Error(d.detail);

    document.getElementById('mon-server-time').textContent = 'Servidor: ' + fmts(d.server_time);

    // KPIs
    const s = d.summary;
    document.getElementById('mon-coll-total').textContent = s.total_candles?.toLocaleString() + ' velas en BD';
    document.getElementById('mon-feat-total').textContent = s.total_features?.toLocaleString() + ' features en BD';
    document.getElementById('mon-last-candle').textContent = s.last_candle ? fmts(s.last_candle) : 'â€”';
    document.getElementById('mon-last-feature').textContent = s.last_feature ? fmts(s.last_feature) : 'â€”';

    // Colorear KPIs segÃºn salud
    const collEl = document.getElementById('mon-coll-health');
    collEl.textContent = s.collector_health;
    const ohlcvCrit  = d.ohlcv.filter(r => r.status === 'critical').length;
    const ohlcvStale = d.ohlcv.filter(r => r.status === 'stale').length;
    collEl.className = 'card-value ' + (ohlcvCrit > 0 ? 'red' : ohlcvStale > 0 ? 'yellow' : 'green');

    const featEl = document.getElementById('mon-feat-health');
    featEl.textContent = s.features_health;
    const featCrit  = d.features.filter(r => r.status === 'critical').length;
    const featStale = d.features.filter(r => r.status === 'stale').length;
    featEl.className = 'card-value ' + (featCrit > 0 ? 'red' : featStale > 0 ? 'yellow' : 'green');

    // Tabla OHLCV
    document.getElementById('mon-ohlcv-tbody').innerHTML = d.ohlcv.map(r => `
      <tr>
        <td><b>${r.pair}</b></td>
        <td>${r.timeframe}</td>
        <td style="font-size:12px">${r.last_update ? fmts(r.last_update) : 'â€”'}</td>
        <td style="${ageColor(r.status)}">${ageText(r.age_minutes)}</td>
        <td>${r.total_rows.toLocaleString()}</td>
        <td>${monStatusBadge(r.status)}</td>
      </tr>`).join('');

    // Tabla Features
    document.getElementById('mon-feat-tbody').innerHTML = d.features.map(r => `
      <tr>
        <td><b>${r.pair}</b></td>
        <td>${r.timeframe}</td>
        <td style="font-size:12px">${r.last_update ? fmts(r.last_update) : 'â€”'}</td>
        <td style="${ageColor(r.status)}">${ageText(r.age_minutes)}</td>
        <td>${r.total_rows.toLocaleString()}</td>
        <td>${monStatusBadge(r.status)}</td>
      </tr>`).join('');

  } catch(e) {
    document.getElementById('mon-ohlcv-tbody').innerHTML =
      `<tr><td colspan="6" style="color:var(--red);padding:20px">Error: ${e.message}</td></tr>`;
  }

  // Auto-refresh cada 30s mientras la pestaÃ±a estÃ© activa
  clearInterval(_monitorInterval);
  if (document.getElementById('mon-auto')?.checked) {
    _monitorInterval = setInterval(() => {
      if (document.getElementById('page-monitor').classList.contains('active')) loadMonitor();
      else clearInterval(_monitorInterval);
    }, 30000);
  }
}

// â”€â”€ ConfiguraciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadConfig() {
  const cfg = await fetch('/api/config').then(r => r.json());
  document.getElementById('cfg-confidence').value = Math.round(cfg.min_confidence * 100);
  document.getElementById('cfg-adx').value        = cfg.min_adx;
  document.getElementById('cfg-rr').value         = cfg.min_rr;
  document.getElementById('cfg-cooldown').value   = cfg.cooldown_bars;
  document.getElementById('cfg-tp').value         = cfg.tp_multiplier;
  document.getElementById('cfg-sl').value         = cfg.sl_multiplier;
  const tog = document.getElementById('cfg-offmarket');
  cfg.allow_offmarket ? tog.classList.add('on') : tog.classList.remove('on');
  document.getElementById('cfg-offmarket-label').textContent = cfg.allow_offmarket ? 'SÃ­' : 'No';
}
function toggleField(id) {
  const el = document.getElementById(id);
  el.classList.toggle('on');
  document.getElementById(id + '-label').textContent = el.classList.contains('on') ? 'SÃ­' : 'No';
}
async function saveConfig() {
  const body = {
    min_confidence:  parseFloat(document.getElementById('cfg-confidence').value) / 100,
    min_adx:         parseFloat(document.getElementById('cfg-adx').value),
    min_rr:          parseFloat(document.getElementById('cfg-rr').value),
    cooldown_bars:   parseInt(document.getElementById('cfg-cooldown').value),
    tp_multiplier:   parseFloat(document.getElementById('cfg-tp').value),
    sl_multiplier:   parseFloat(document.getElementById('cfg-sl').value),
    allow_offmarket: document.getElementById('cfg-offmarket').classList.contains('on'),
  };
  const res = await fetch('/api/config', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
  });
  if (res.ok) {
    const msg = document.getElementById('save-msg');
    msg.style.display = 'inline';
    setTimeout(() => msg.style.display = 'none', 3000);
  }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadDashboard();
setInterval(loadDashboard, 30000);
</script>
</body>
</html>
