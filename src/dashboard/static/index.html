<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ML-Ayram Dashboard</title>
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  :root {
    --bg:      #0d1117;
    --surface: #161b22;
    --border:  #30363d;
    --text:    #e6edf3;
    --muted:   #8b949e;
    --green:   #3fb950;
    --red:     #f85149;
    --blue:    #58a6ff;
    --yellow:  #d29922;
    --purple:  #bc8cff;
    --radius:  8px;
    --nav-h:   56px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 14px; }

  nav { height: var(--nav-h); background: var(--surface); border-bottom: 1px solid var(--border);
        display: flex; align-items: center; padding: 0 24px; gap: 24px; position: sticky; top: 0; z-index: 100; }
  .nav-brand { font-weight: 700; font-size: 16px; color: var(--blue); letter-spacing: .5px; white-space: nowrap; }
  .nav-links { display: flex; gap: 2px; flex-wrap: wrap; }
  .nav-link { padding: 6px 12px; border-radius: var(--radius); cursor: pointer; color: var(--muted);
              border: none; background: none; font-size: 13px; transition: all .15s; white-space: nowrap; }
  .nav-link:hover { color: var(--text); background: var(--border); }
  .nav-link.active { color: var(--text); background: #21262d; }
  .nav-status { margin-left: auto; display: flex; align-items: center; gap: 8px; color: var(--muted); font-size: 13px; white-space: nowrap; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

  /* Hamburger button â€” hidden on desktop */
  .nav-burger { display: none; background: none; border: 1px solid var(--border); border-radius: var(--radius);
    color: var(--text); font-size: 22px; padding: 4px 10px; cursor: pointer; line-height: 1; }
  .nav-burger:hover { background: var(--border); }

  .page { display: none; padding: 24px; max-width: 1400px; margin: 0 auto; }
  .page.active { display: block; }

  .grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 24px; }
  .grid-3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 16px; margin-bottom: 24px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
  .card-title { font-size: 12px; text-transform: uppercase; letter-spacing: .8px; color: var(--muted); margin-bottom: 8px; }
  .card-value { font-size: 28px; font-weight: 700; }
  .card-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .green  { color: var(--green); }
  .red    { color: var(--red); }
  .blue   { color: var(--blue); }
  .yellow { color: var(--yellow); }
  .purple { color: var(--purple); }

  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .section-title { font-size: 16px; font-weight: 600; }

  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 10px 12px; color: var(--muted); font-weight: 500;
       border-bottom: 1px solid var(--border); white-space: nowrap; }
  td { padding: 10px 12px; border-bottom: 1px solid #21262d; white-space: nowrap; }
  tr:hover td { background: #21262d44; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .badge-long  { background: #3fb95022; color: var(--green); border: 1px solid #3fb95044; }
  .badge-short { background: #f8514922; color: var(--red);   border: 1px solid #f8514944; }
  .badge-neut  { background: #8b949e22; color: var(--muted); border: 1px solid #8b949e44; }
  .badge-tp    { background: #3fb95022; color: var(--green); border: 1px solid #3fb95044; }
  .badge-sl    { background: #f8514922; color: var(--red);   border: 1px solid #f8514944; }
  .conf-bar  { width: 60px; height: 6px; background: var(--border); border-radius: 3px; display: inline-block; vertical-align: middle; overflow: hidden; }
  .conf-fill { height: 100%; background: var(--blue); border-radius: 3px; }

  #chart-container { height: 480px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .chart-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  select, input[type=number], input[type=text] {
    background: var(--surface); border: 1px solid var(--border); color: var(--text);
    border-radius: var(--radius); padding: 6px 10px; font-size: 13px; outline: none; }
  select:focus, input:focus { border-color: var(--blue); }

  .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .field { display: flex; flex-direction: column; gap: 6px; }
  .field label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
  .field input[type=number], .field input[type=text] { width: 100%; }
  .field-toggle { display: flex; align-items: center; gap: 10px; }
  .toggle { width: 40px; height: 22px; background: var(--border); border-radius: 11px; position: relative; cursor: pointer; transition: background .2s; }
  .toggle.on { background: var(--green); }
  .toggle::after { content:''; position: absolute; top: 3px; left: 3px; width: 16px; height: 16px;
                   border-radius: 50%; background: white; transition: left .2s; }
  .toggle.on::after { left: 21px; }
  .btn { padding: 8px 18px; border-radius: var(--radius); border: none; cursor: pointer;
         font-size: 14px; font-weight: 500; transition: opacity .15s; }
  .btn-primary { background: var(--blue); color: #0d1117; }
  .btn-primary:hover { opacity: .85; }
  .btn-ghost { background: var(--border); color: var(--text); }
  .btn-ghost:hover { opacity: .85; }
  .save-msg { font-size: 12px; color: var(--green); display: none; }

  .pagination { display: flex; gap: 8px; align-items: center; margin-top: 16px; }
  .page-btn { padding: 4px 10px; border-radius: 4px; border: 1px solid var(--border);
              background: none; color: var(--text); cursor: pointer; }
  .page-btn:disabled { opacity: .3; cursor: default; }
  .page-info { color: var(--muted); font-size: 13px; }

  .filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
  .chart-sm { height: 220px; }
  .empty-state { padding: 48px; text-align: center; color: var(--muted); font-size: 15px; }
  .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border);
             border-top-color: var(--blue); border-radius: 50%; animation: spin .7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .pnl-pos { color: var(--green); font-weight: 600; }
  .pnl-neg { color: var(--red);   font-weight: 600; }

  /* â”€â”€ Pipeline bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .pipeline-task { margin-bottom: 20px; }
  .pipeline-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .pipeline-label { font-size: 13px; font-weight: 600; }
  .pipeline-stats { font-size: 11px; color: var(--muted); display: flex; gap: 12px; }
  .pipeline-bar { display: flex; gap: 1px; align-items: stretch; height: 28px; }
  .pipeline-cell {
    flex: 1; min-width: 3px; border-radius: 2px; cursor: pointer;
    transition: opacity .15s; position: relative;
  }
  .pipeline-cell:hover { opacity: .75; }
  .pipeline-cell.success  { background: var(--green); }
  .pipeline-cell.error    { background: var(--red); }
  .pipeline-cell.skipped  { background: #30363d; }
  .pipeline-cell.pending  { background: #161b22; border: 1px solid #21262d; }
  .pipeline-cell.running  { background: var(--blue); animation: pulse 1s infinite; }
  .pipeline-cell.weekend  { background: #1c2028; }

  .pipeline-tooltip {
    position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
    background: #21262d; color: var(--text); padding: 6px 10px; border-radius: 6px;
    font-size: 11px; white-space: nowrap; z-index: 50; pointer-events: none;
    display: none; box-shadow: 0 4px 12px rgba(0,0,0,.3);
  }
  .pipeline-cell:hover .pipeline-tooltip { display: block; }

  .pipeline-hours { display: flex; justify-content: space-between; margin-top: 4px; }
  .pipeline-hours span { font-size: 10px; color: var(--muted); }

  .market-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px;
                  border-radius: 12px; font-size: 12px; font-weight: 600; }
  .market-open   { background: #3fb95022; color: var(--green); border: 1px solid #3fb95044; }
  .market-closed { background: #f8514922; color: var(--red);   border: 1px solid #f8514944; }

  .error-log { max-height: 400px; overflow-y: auto; }

  /* â”€â”€ Bot config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .chip-group { display: flex; flex-wrap: wrap; gap: 6px; }
  .chip { padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500;
          border: 1px solid var(--border); background: none; color: var(--muted); cursor: pointer;
          transition: all .15s; }
  .chip.active { background: var(--blue); color: #0d1117; border-color: var(--blue); }
  .chip:hover { border-color: var(--blue); }
  .bot-section { margin-bottom: 28px; }
  .bot-section-title { font-size: 14px; font-weight: 600; margin-bottom: 14px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }

  /* â”€â”€ Trading sessions timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sessions-timeline { position: relative; margin: 20px 0; }
  .session-row { display: flex; align-items: center; margin-bottom: 6px; min-height: 32px; }
  .session-label { width: 100px; font-size: 12px; font-weight: 600; flex-shrink: 0; }
  .session-track { flex: 1; position: relative; height: 28px; background: #0d1117; border-radius: 4px; overflow: hidden; }
  .session-bar { position: absolute; top: 2px; height: 24px; border-radius: 3px; display: flex;
                 align-items: center; justify-content: center; font-size: 10px; font-weight: 600;
                 color: rgba(255,255,255,.85); }
  .session-hours { display: flex; font-size: 10px; color: var(--muted); margin-top: 4px; margin-left: 100px; }
  .session-hours span { flex: 1; text-align: center; min-width: 0; }
  .overlap-zone { position: absolute; top: 0; height: 100%; background: rgba(255,255,255,.08);
                  border-left: 1px dashed rgba(255,255,255,.15); border-right: 1px dashed rgba(255,255,255,.15); }
  .overlap-label { position: absolute; top: -16px; font-size: 9px; color: var(--yellow); white-space: nowrap;
                   left: 50%; transform: translateX(-50%); }
  .session-now { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--yellow);
                 z-index: 10; }
  .session-now::after { content: 'â–¼'; position: absolute; top: -14px; left: -4px; font-size: 10px; color: var(--yellow); }

  /* â”€â”€ Correlation matrix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .corr-table { border-collapse: collapse; width: auto; }
  .corr-table th, .corr-table td { padding: 8px 12px; text-align: center; font-size: 12px;
                                    border: 1px solid var(--border); min-width: 72px; }
  .corr-table th { background: #21262d; font-weight: 600; }
  .corr-cell { font-weight: 600; font-size: 13px; }
  .corr-legend { display: flex; align-items: center; gap: 4px; margin-top: 12px; font-size: 11px; color: var(--muted); }
  .corr-legend-bar { width: 120px; height: 10px; border-radius: 3px;
    background: linear-gradient(90deg, #f85149, #f8514944, #161b22, #3fb95044, #3fb950); }

  /* â”€â”€ Training monitor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .train-progress-outer { width: 100%; height: 24px; background: var(--border); border-radius: 12px; overflow: hidden; position: relative; }
  .train-progress-inner { height: 100%; border-radius: 12px; transition: width .5s ease; display: flex; align-items: center; justify-content: center;
                          font-size: 11px; font-weight: 700; color: #0d1117; min-width: 40px; }
  .train-status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px;
                        border-radius: 20px; font-size: 13px; font-weight: 600; }
  .train-running  { background: #58a6ff22; color: var(--blue); border: 1px solid #58a6ff44; }
  .train-inactive { background: #8b949e22; color: var(--muted); border: 1px solid #8b949e44; }
  .train-failed   { background: #f8514922; color: var(--red); border: 1px solid #f8514944; }
  .train-model-card { display: flex; align-items: center; gap: 16px; padding: 16px; background: #0d1117;
                      border: 1px solid var(--border); border-radius: var(--radius); }
  .train-model-icon { font-size: 32px; }
  .train-model-info { flex: 1; }
  .train-model-name { font-size: 16px; font-weight: 700; }
  .train-model-detail { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .train-log { background: #010409; border: 1px solid var(--border); border-radius: var(--radius);
               padding: 12px; max-height: 400px; overflow-y: auto; font-family: 'JetBrains Mono', 'Fira Code', monospace;
               font-size: 11px; line-height: 1.6; color: var(--muted); white-space: pre-wrap; word-break: break-all; }
  .train-log .log-info    { color: var(--blue); }
  .train-log .log-success { color: var(--green); }
  .train-log .log-warning { color: var(--yellow); }
  .train-log .log-error   { color: var(--red); }
  .completed-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; }
  .completed-chip { padding: 8px 12px; border-radius: var(--radius); background: #0d1117;
                    border: 1px solid var(--border); font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
  .completed-chip .chip-type { font-weight: 600; }
  .completed-chip .chip-f1 { color: var(--green); font-weight: 600; }

  /* â”€â”€ Backtest panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .bt-config { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; padding: 16px; background: var(--surface);
    border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 20px; }
  .bt-config label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .bt-config .bt-field { display: flex; flex-direction: column; gap: 4px; }
  .bt-config select, .bt-config input { background: var(--bg); color: var(--text); border: 1px solid var(--border);
    border-radius: 6px; padding: 8px 10px; font-size: 13px; }
  .bt-config select { min-width: 140px; }
  .bt-config select[multiple] { min-height: 80px; }
  .bt-run-btn { padding: 10px 28px; background: var(--blue); color: #fff; border: none; border-radius: 6px;
    font-weight: 600; font-size: 14px; cursor: pointer; transition: all .15s; align-self: end; }
  .bt-run-btn:hover { background: #4c93e6; }
  .bt-run-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .bt-run-btn.running { animation: pulse 1s infinite; }
  .bt-results { display: none; }
  .bt-results.visible { display: block; }
  .bt-kpi-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 20px; }
  .bt-kpi { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 16px; text-align: center; }
  .bt-kpi .kpi-val { font-size: 24px; font-weight: 700; }
  .bt-kpi .kpi-label { font-size: 11px; color: var(--muted); text-transform: uppercase; margin-top: 4px; }
  .bt-charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 20px; }
  .bt-chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
  .bt-chart-card h4 { margin: 0 0 12px; font-size: 14px; color: var(--muted); }
  .bt-breakdown-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px; }
  .bt-trades-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .bt-trades-table th { background: #0d1117; padding: 10px 8px; text-align: left; border-bottom: 1px solid var(--border);
    font-weight: 600; color: var(--muted); text-transform: uppercase; font-size: 10px; position: sticky; top: 0; }
  .bt-trades-table td { padding: 8px; border-bottom: 1px solid #21262d; }
  .bt-trades-table tr:hover td { background: #161b2244; }
  .bt-trades-wrap { max-height: 400px; overflow-y: auto; background: var(--surface);
    border: 1px solid var(--border); border-radius: var(--radius); }
  .bt-empty { text-align: center; padding: 60px 20px; color: var(--muted); }
  .bt-empty .icon { font-size: 48px; margin-bottom: 12px; }
  @media(max-width:1100px) {
    .bt-kpi-grid { grid-template-columns: repeat(3, 1fr); }
    .bt-charts-row, .bt-breakdown-row { grid-template-columns: 1fr; }
  }

  /* â”€â”€ Docs panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .docs-layout { display: grid; grid-template-columns: 260px 1fr; gap: 20px; min-height: 60vh; }
  .docs-sidebar { display: flex; flex-direction: column; gap: 6px; }
  .docs-file-btn { display: flex; flex-direction: column; gap: 2px; padding: 12px 16px; background: var(--surface);
    border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; text-align: left;
    transition: all .15s ease; color: var(--text); }
  .docs-file-btn:hover { border-color: var(--blue); background: #161b2288; }
  .docs-file-btn.active { border-color: var(--blue); background: #58a6ff15; box-shadow: inset 3px 0 0 var(--blue); }
  .docs-file-btn .doc-name { font-weight: 600; font-size: 13px; }
  .docs-file-btn .doc-meta { font-size: 11px; color: var(--muted); }
  .docs-content { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 32px 40px; overflow-x: auto; }
  /* Markdown rendered styles */
  .md-body h1 { font-size: 28px; font-weight: 700; margin: 0 0 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); color: var(--text); }
  .md-body h2 { font-size: 22px; font-weight: 700; margin: 32px 0 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); color: var(--text); }
  .md-body h3 { font-size: 17px; font-weight: 600; margin: 24px 0 8px; color: var(--blue); }
  .md-body h4 { font-size: 15px; font-weight: 600; margin: 20px 0 6px; color: var(--muted); }
  .md-body p { margin: 10px 0; line-height: 1.7; color: #c9d1d9; }
  .md-body ul, .md-body ol { margin: 10px 0; padding-left: 24px; }
  .md-body li { margin: 4px 0; line-height: 1.6; }
  .md-body a { color: var(--blue); text-decoration: none; }
  .md-body a:hover { text-decoration: underline; }
  .md-body code { background: #0d1117; padding: 2px 6px; border-radius: 4px; font-size: 13px;
    font-family: 'JetBrains Mono', 'Fira Code', monospace; color: var(--yellow); }
  .md-body pre { background: #010409; border: 1px solid var(--border); border-radius: var(--radius);
    padding: 16px; overflow-x: auto; margin: 16px 0; }
  .md-body pre code { background: none; padding: 0; color: #c9d1d9; font-size: 12px; line-height: 1.6; }
  .md-body blockquote { border-left: 3px solid var(--blue); padding: 8px 16px; margin: 16px 0;
    background: #58a6ff08; color: var(--muted); font-style: italic; }
  .md-body table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 13px; }
  .md-body th { background: #0d1117; padding: 10px 12px; text-align: left; border: 1px solid var(--border);
    font-weight: 600; color: var(--text); }
  .md-body td { padding: 8px 12px; border: 1px solid var(--border); color: #c9d1d9; }
  .md-body tr:hover td { background: #161b2244; }
  .md-body hr { border: none; border-top: 1px solid var(--border); margin: 24px 0; }
  .md-body strong { color: var(--text); }
  .md-body img { max-width: 100%; border-radius: var(--radius); }
  @media(max-width:900px) { .docs-layout { grid-template-columns: 1fr; } }

  /* Alerts page */
  .alerts-tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid var(--border); }
  .alerts-tab { padding: 10px 20px; background: none; border: none; color: var(--muted); font-size: 13px; font-weight: 600;
    cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all .2s; }
  .alerts-tab:hover { color: var(--text); }
  .alerts-tab.active { color: var(--blue); border-bottom-color: var(--blue); }
  .alerts-panel { display: none; }
  .alerts-panel.active { display: block; }
  .notif-filters { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; margin-bottom: 16px; }
  .notif-filters select, .notif-filters input { background: var(--bg); color: var(--text); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 6px 10px; font-size: 12px; }
  .notif-filters label { font-size: 11px; color: var(--muted); text-transform: uppercase; }
  .notif-filters .nf-field { display: flex; flex-direction: column; gap: 4px; }
  .notif-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .notif-table th { text-align: left; padding: 8px 10px; color: var(--muted); font-size: 11px; text-transform: uppercase;
    border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--surface); }
  .notif-table td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: top; }
  .notif-table tr:hover td { background: rgba(255,255,255,0.02); }
  .notif-wrap { max-height: 500px; overflow-y: auto; background: var(--surface); border-radius: var(--radius);
    border: 1px solid var(--border); }
  .notif-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
  .notif-badge.signal { background: rgba(30,144,255,0.15); color: #1e90ff; }
  .notif-badge.training { background: rgba(255,165,0,0.15); color: #ffa500; }
  .notif-badge.anomaly { background: rgba(255,60,60,0.15); color: #ff3c3c; }
  .notif-badge.heartbeat { background: rgba(80,200,120,0.15); color: #50c878; }
  .notif-badge.error { background: rgba(255,0,0,0.2); color: #ff4444; }
  .notif-badge.summary { background: rgba(180,130,255,0.15); color: #b482ff; }
  .notif-badge.alert_rule { background: rgba(255,215,0,0.15); color: #ffd700; }
  .sev-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; }
  .sev-badge.info { background: rgba(100,100,255,0.12); color: #8888ff; }
  .sev-badge.warning { background: rgba(255,165,0,0.15); color: #ffa500; }
  .sev-badge.high { background: rgba(255,80,80,0.15); color: #ff5050; }
  .sev-badge.critical { background: rgba(255,0,0,0.25); color: #ff2222; }
  .notif-stats { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
  .notif-stat { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 10px 16px; display: flex; flex-direction: column; align-items: center; min-width: 80px; }
  .notif-stat .ns-val { font-size: 22px; font-weight: 700; color: var(--text); }
  .notif-stat .ns-label { font-size: 10px; color: var(--muted); text-transform: uppercase; margin-top: 2px; }
  .rule-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 16px; display: flex; align-items: center; gap: 16px; margin-bottom: 10px; transition: border-color .2s; }
  .rule-card:hover { border-color: var(--blue); }
  .rule-toggle { width: 44px; height: 24px; border-radius: 12px; background: #333; position: relative;
    cursor: pointer; transition: background .2s; flex-shrink: 0; border: none; }
  .rule-toggle::after { content: ''; position: absolute; width: 18px; height: 18px; border-radius: 50%;
    background: #888; top: 3px; left: 3px; transition: all .2s; }
  .rule-toggle.on { background: var(--blue); }
  .rule-toggle.on::after { left: 23px; background: #fff; }
  .rule-info { flex: 1; }
  .rule-name { font-weight: 600; font-size: 14px; color: var(--text); }
  .rule-desc { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .rule-meta { display: flex; gap: 12px; margin-top: 6px; }
  .rule-meta span { font-size: 11px; color: var(--muted); }
  .rule-meta span b { color: var(--text); }
  .rule-actions { display: flex; gap: 6px; flex-shrink: 0; }
  .rule-actions button { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 6px 10px; color: var(--muted); cursor: pointer; font-size: 12px; transition: all .2s; }
  .rule-actions button:hover { border-color: var(--blue); color: var(--text); }
  .rule-actions button.del:hover { border-color: #ff4444; color: #ff4444; }
  .add-rule-form { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 20px; margin-top: 16px; display: none; }
  .add-rule-form.show { display: block; }
  .add-rule-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
  .add-rule-grid label { font-size: 11px; color: var(--muted); text-transform: uppercase; }
  .add-rule-grid .arf { display: flex; flex-direction: column; gap: 4px; }
  .add-rule-grid select, .add-rule-grid input { background: var(--bg); color: var(--text); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 8px 10px; font-size: 12px; }
  .add-rule-btn { margin-top: 14px; display: flex; gap: 10px; }
  .add-rule-btn button { padding: 8px 20px; border-radius: var(--radius); border: none; font-weight: 600;
    cursor: pointer; font-size: 13px; }
  .add-rule-btn .save { background: var(--blue); color: #fff; }
  .add-rule-btn .cancel { background: var(--bg); color: var(--muted); border: 1px solid var(--border); }

  /* â”€â”€ Models comparator page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .models-filter { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 20px; }
  .models-filter select { background: var(--bg); color: var(--text); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 8px 12px; font-size: 13px; }
  .models-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); gap: 16px; }
  .model-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
  .model-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
    padding-bottom: 12px; border-bottom: 1px solid var(--border); }
  .model-pair { font-size: 18px; font-weight: 700; color: var(--text); }
  .model-tf { font-size: 13px; color: var(--muted); background: var(--bg); padding: 3px 10px; border-radius: 12px; }
  .model-vs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .model-side { background: var(--bg); border-radius: var(--radius); padding: 14px; position: relative; }
  .model-side-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .8px;
    margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
  .model-side.xgb .model-side-title { color: var(--blue); }
  .model-side.lstm .model-side-title { color: var(--purple); }
  .model-metric { display: flex; justify-content: space-between; padding: 5px 0;
    font-size: 13px; border-bottom: 1px solid rgba(255,255,255,.04); }
  .model-metric:last-child { border-bottom: none; }
  .model-metric .mk { color: var(--muted); }
  .model-metric .mv { font-weight: 600; color: var(--text); }
  .model-metric .mv.winner { color: var(--green); }
  .model-no-data { color: var(--muted); font-size: 12px; font-style: italic; padding: 20px 0; text-align: center; }
  .f1-bar-wrap { height: 6px; background: #21262d; border-radius: 3px; margin-top: 8px; overflow: hidden; }
  .f1-bar { height: 100%; border-radius: 3px; transition: width .4s ease; }
  .f1-bar.xgb { background: var(--blue); }
  .f1-bar.lstm { background: var(--purple); }
  .models-summary { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .ms-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 14px; text-align: center; }
  .ms-val { font-size: 24px; font-weight: 700; }
  .ms-label { font-size: 11px; color: var(--muted); text-transform: uppercase; margin-top: 4px; }

  /* â”€â”€ Responsive: Tablet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media(max-width:900px) {
    .grid-4,.grid-3 { grid-template-columns: 1fr 1fr; }
    .config-grid,.grid-2 { grid-template-columns: 1fr; }
    nav { padding: 0 12px; gap: 8px; }
    .models-grid { grid-template-columns: 1fr; }
  }

  /* â”€â”€ Responsive: Mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media(max-width:768px) {
    nav { height: auto; min-height: var(--nav-h); flex-wrap: wrap; padding: 10px 12px; gap: 8px; }
    .nav-burger { display: block; }
    .nav-links { display: none; width: 100%; flex-direction: column; gap: 2px;
      padding-top: 8px; border-top: 1px solid var(--border); }
    .nav-links.open { display: flex; }
    .nav-link { padding: 10px 12px; font-size: 14px; }
    .nav-status { display: none; }
    .page { padding: 14px 10px; }
    .card-value { font-size: 22px; }
    .grid-4,.grid-3 { grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-2 { grid-template-columns: 1fr; gap: 10px; }
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { min-width: 600px; }
    .chart-box { height: 260px !important; }
    .section-header { flex-direction: column; gap: 8px; align-items: flex-start !important; }
    .model-vs { grid-template-columns: 1fr; }
    .docs-content { padding: 16px; }
    .notif-filters { flex-direction: column; }
    .alerts-tabs { overflow-x: auto; }
    .models-summary { grid-template-columns: 1fr 1fr; }
    .models-filter { flex-direction: column; align-items: stretch; }
  }

  @media(max-width:500px) {
    .grid-4,.grid-3 { grid-template-columns: 1fr; }
    .models-summary { grid-template-columns: 1fr; }
    .bt-kpi-grid { grid-template-columns: 1fr 1fr; }
    body { padding-bottom: env(safe-area-inset-bottom, 0); }
    .page { padding: 10px 8px; }
    table { min-width: 500px; font-size: 12px; }
    .card { padding: 14px; }
    .model-card { padding: 14px; }
    .model-pair { font-size: 16px; }
    .ms-val { font-size: 20px; }
  }

  /* Touch improvements */
  @media(hover:none) and (pointer:coarse) {
    .nav-link, button, select, .alerts-tab { touch-action: manipulation; min-height: 44px; }
    .table-wrap { -webkit-overflow-scrolling: touch; scroll-snap-type: x proximity; }
  }
</style>
</head>
<body>

<nav>
  <span class="nav-brand">ğŸ“ˆ ML-Ayram</span>
  <button class="nav-burger" onclick="document.querySelector('.nav-links').classList.toggle('open')" aria-label="MenÃº">â˜°</button>
  <div class="nav-links">
    <button class="nav-link active"  onclick="showPage('dashboard',this)">Dashboard</button>
    <button class="nav-link"         onclick="showPage('pipeline',this)">Pipeline</button>
    <button class="nav-link"         onclick="showPage('chart',this)">GrÃ¡fico</button>
    <button class="nav-link"         onclick="showPage('history',this)">Historial</button>
    <button class="nav-link"         onclick="showPage('metrics',this)">MÃ©tricas</button>
    <button class="nav-link"         onclick="showPage('performance',this)">Rendimiento</button>
    <button class="nav-link"         onclick="showPage('monitor',this)">Monitor</button>
    <button class="nav-link"         onclick="showPage('market',this)">Mercado</button>
    <button class="nav-link"         onclick="showPage('train',this)">Train</button>
    <button class="nav-link"         onclick="showPage('bot',this)">Bot</button>
    <button class="nav-link"         onclick="showPage('config',this)">SeÃ±ales</button>
    <button class="nav-link"         onclick="showPage('backtest',this)">ğŸ¯ Backtest</button>
    <button class="nav-link"         onclick="showPage('docs',this)">ğŸ“š Docs</button>
    <button class="nav-link"         onclick="showPage('alerts',this)">ğŸ”” Alertas</button>
    <button class="nav-link"         onclick="showPage('models',this)">ğŸ§  Modelos</button>
  </div>
  <div class="nav-status">
    <div class="dot" id="status-dot"></div>
    <span id="status-text">Conectandoâ€¦</span>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â• -->
<div id="page-dashboard" class="page active">
  <div class="grid-4">
    <div class="card">
      <div class="card-title">SeÃ±ales hoy</div>
      <div class="card-value blue" id="kpi-today">â€”</div>
      <div class="card-sub">vÃ¡lidas (UTC)</div>
    </div>
    <div class="card">
      <div class="card-title">Ãšltima seÃ±al</div>
      <div class="card-value" id="kpi-last-dir">â€”</div>
      <div class="card-sub" id="kpi-last-ts">â€”</div>
    </div>
    <div class="card">
      <div class="card-title">Posiciones abiertas</div>
      <div class="card-value yellow" id="kpi-positions">â€”</div>
      <div class="card-sub" id="kpi-positions-pnl">PnL flotante: â€”</div>
    </div>
    <div class="card">
      <div class="card-title">Velas en BD</div>
      <div class="card-value purple" id="kpi-bars">â€”</div>
      <div class="card-sub">OHLCV raw</div>
    </div>
  </div>

  <div class="card" style="margin-bottom:16px" id="positions-card">
    <div class="section-header">
      <span class="section-title">Posiciones abiertas</span>
      <button class="btn btn-ghost" onclick="loadDashboard()">â†» Actualizar</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Par</th><th>TF</th><th>DirecciÃ³n</th><th>Entrada</th>
          <th>Precio actual</th><th>TP</th><th>SL</th><th>Lotes</th>
          <th>Riesgo â‚¬</th><th>PnL flotante</th><th>Abierto</th>
        </tr></thead>
        <tbody id="positions-tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="section-header">
      <span class="section-title">SeÃ±ales recientes</span>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Hora (UTC)</th><th>Par</th><th>TF</th><th>DirecciÃ³n</th>
          <th>Entrada</th><th>TP</th><th>SL</th><th>R:R</th>
          <th>Confianza</th><th>ADX</th><th>SesiÃ³n</th><th>Estado</th>
        </tr></thead>
        <tbody id="latest-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• PIPELINE â•â•â•â•â•â•â•â•â•â• -->
<div id="page-pipeline" class="page">
  <div class="section-header" style="margin-bottom:20px">
    <div style="display:flex;align-items:center;gap:16px">
      <span class="section-title">ğŸ”„ Pipeline de ejecuciÃ³n</span>
      <span id="pipe-market-badge" class="market-badge market-closed">â€” Mercado</span>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <select id="pipe-hours" onchange="loadPipeline()">
        <option value="24" selected>Ãšltimas 24h</option>
        <option value="48">Ãšltimas 48h</option>
        <option value="72">Ãšltimos 3 dÃ­as</option>
        <option value="168">Ãšltima semana</option>
      </select>
      <button class="btn btn-ghost" onclick="loadPipeline()">â†»</button>
    </div>
  </div>

  <div class="card" style="margin-bottom:20px">
    <div style="display:flex;gap:24px;align-items:center;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:6px;font-size:12px">
        <span style="width:12px;height:12px;background:var(--green);border-radius:2px;display:inline-block"></span> OK
      </div>
      <div style="display:flex;align-items:center;gap:6px;font-size:12px">
        <span style="width:12px;height:12px;background:var(--red);border-radius:2px;display:inline-block"></span> Error
      </div>
      <div style="display:flex;align-items:center;gap:6px;font-size:12px">
        <span style="width:12px;height:12px;background:#30363d;border-radius:2px;display:inline-block"></span> Saltado
      </div>
      <div style="display:flex;align-items:center;gap:6px;font-size:12px">
        <span style="width:12px;height:12px;background:#1c2028;border:1px solid #21262d;border-radius:2px;display:inline-block"></span> Pendiente
      </div>
      <div style="display:flex;align-items:center;gap:6px;font-size:12px">
        <span style="width:12px;height:12px;background:var(--blue);border-radius:2px;display:inline-block"></span> En curso
      </div>
    </div>
    <div id="pipeline-bars"></div>
  </div>

  <!-- Resumen por tarea -->
  <div class="grid-3" id="pipeline-stats-grid" style="margin-bottom:20px"></div>

  <!-- Log de errores -->
  <div class="card">
    <div class="section-header">
      <span class="section-title">ğŸ›‘ Log de errores</span>
    </div>
    <div class="error-log">
      <table>
        <thead><tr>
          <th>Hora (UTC)</th><th>Tarea</th><th>Error</th><th>DuraciÃ³n</th>
        </tr></thead>
        <tbody id="pipe-errors-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• GRÃFICO â•â•â•â•â•â•â•â•â•â• -->
<div id="page-chart" class="page">
  <div class="card" style="margin-bottom:16px">
    <div class="chart-controls">
      <select id="chart-pair">
        <option>EURUSD</option><option>GBPUSD</option>
        <option>USDJPY</option><option>EURJPY</option><option>XAUUSD</option>
      </select>
      <select id="chart-tf">
        <option>M15</option><option value="H1" selected>H1</option>
        <option>H4</option><option>D1</option>
      </select>
      <select id="chart-bars">
        <option value="100">100 velas</option>
        <option value="200" selected>200 velas</option>
        <option value="500">500 velas</option>
      </select>
      <button class="btn btn-primary" onclick="loadChart()">Cargar</button>
      <label style="display:flex;align-items:center;gap:6px;color:var(--muted)">
        <input type="checkbox" id="show-signals" checked> SeÃ±ales
      </label>
    </div>
  </div>
  <div id="chart-container"></div>
  <div style="padding:12px 0;color:var(--muted);font-size:12px">
    ğŸŸ¢ SeÃ±al LONG &nbsp;|&nbsp; ğŸ”´ SeÃ±al SHORT &nbsp;|&nbsp; LÃ­neas punteadas: TP (verde) / SL (rojo)
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• HISTORIAL â•â•â•â•â•â•â•â•â•â• -->
<div id="page-history" class="page">
  <div class="filters">
    <select id="hist-pair"><option value="">Todos los pares</option>
      <option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>EURJPY</option><option>XAUUSD</option></select>
    <select id="hist-tf"><option value="">Todos TF</option>
      <option>M15</option><option>H1</option><option>H4</option></select>
    <select id="hist-dir"><option value="">Todas</option>
      <option value="1">LONG</option><option value="-1">SHORT</option></select>
    <select id="hist-days">
      <option value="7">7 dÃ­as</option><option value="30" selected>30 dÃ­as</option>
      <option value="90">90 dÃ­as</option><option value="365">1 aÃ±o</option></select>
    <button class="btn btn-primary" onclick="loadHistory(1)">Filtrar</button>
  </div>
  <div class="card">
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Hora (UTC)</th><th>Par</th><th>TF</th><th>DirecciÃ³n</th>
          <th>Entrada</th><th>TP</th><th>SL</th><th>R:R</th>
          <th>TP pips</th><th>SL pips</th><th>Confianza</th>
          <th>XGB</th><th>LSTM</th><th>ADX</th><th>SesiÃ³n</th>
        </tr></thead>
        <tbody id="hist-tbody"></tbody>
      </table>
    </div>
    <div class="pagination">
      <button class="page-btn" id="hist-prev" onclick="histPage(-1)">â€¹ Anterior</button>
      <span class="page-info" id="hist-page-info"></span>
      <button class="page-btn" id="hist-next" onclick="histPage(1)">Siguiente â€º</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• MÃ‰TRICAS â•â•â•â•â•â•â•â•â•â• -->
<div id="page-metrics" class="page">
  <div class="filters">
    <select id="met-pair"><option value="">Todos los pares</option>
      <option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>EURJPY</option><option>XAUUSD</option></select>
    <select id="met-tf"><option value="">Todos TF</option>
      <option>M15</option><option>H1</option><option>H4</option></select>
    <select id="met-days">
      <option value="30">30 dÃ­as</option><option value="90" selected>90 dÃ­as</option>
      <option value="180">180 dÃ­as</option><option value="365">1 aÃ±o</option></select>
    <button class="btn btn-primary" onclick="loadMetrics()">Aplicar</button>
  </div>
  <div class="grid-4">
    <div class="card"><div class="card-title">Total seÃ±ales</div><div class="card-value blue" id="m-total">â€”</div></div>
    <div class="card"><div class="card-title">Conf. promedio</div><div class="card-value green" id="m-conf">â€”</div></div>
    <div class="card"><div class="card-title">R:R promedio</div><div class="card-value yellow" id="m-rr">â€”</div></div>
    <div class="card"><div class="card-title">Acuerdo modelos</div><div class="card-value purple" id="m-agree">â€”</div></div>
  </div>
  <div class="grid-2">
    <div class="card">
      <div class="section-title" style="margin-bottom:14px">DistribuciÃ³n Long / Short</div>
      <div class="chart-sm"><canvas id="chart-dir"></canvas></div>
    </div>
    <div class="card">
      <div class="section-title" style="margin-bottom:14px">SeÃ±ales por par</div>
      <div class="chart-sm"><canvas id="chart-pairs"></canvas></div>
    </div>
  </div>
  <div class="card">
    <div class="section-title" style="margin-bottom:14px">SeÃ±ales por dÃ­a (Ãºltimos 30 dÃ­as)</div>
    <div style="height:200px"><canvas id="chart-daily"></canvas></div>
  </div>
  <div class="grid-2" style="margin-top:16px">
    <div class="card">
      <div class="section-title" style="margin-bottom:14px">SeÃ±ales por timeframe</div>
      <div class="chart-sm"><canvas id="chart-tf-dist"></canvas></div>
    </div>
    <div class="card">
      <div class="section-title" style="margin-bottom:14px">Long vs Short por par</div>
      <div class="chart-sm"><canvas id="chart-pair-dir"></canvas></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• RENDIMIENTO â•â•â•â•â•â•â•â•â•â• -->
<div id="page-performance" class="page">
  <div class="filters">
    <select id="perf-pair"><option value="">Todos los pares</option>
      <option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>EURJPY</option><option>XAUUSD</option></select>
    <select id="perf-tf"><option value="">Todos TF</option>
      <option>M15</option><option>H1</option><option>H4</option></select>
    <select id="perf-days">
      <option value="7">7 dÃ­as</option><option value="30" selected>30 dÃ­as</option>
      <option value="90">90 dÃ­as</option><option value="365">Todo</option></select>
    <button class="btn btn-primary" onclick="loadPerformance()">Aplicar</button>
  </div>
  <div id="perf-empty" class="card empty-state" style="display:none">
    ğŸ“Š AÃºn no hay trades cerrados. Los resultados aparecerÃ¡n cuando el position manager cierre la primera posiciÃ³n.
  </div>
  <div id="perf-content">
    <div class="grid-4">
      <div class="card"><div class="card-title">PnL total</div><div class="card-value" id="p-pnl">â€”</div><div class="card-sub" id="p-trades">â€” trades</div></div>
      <div class="card"><div class="card-title">Win rate</div><div class="card-value green" id="p-wr">â€”</div><div class="card-sub" id="p-wl">â€” / â€”</div></div>
      <div class="card"><div class="card-title">Profit factor</div><div class="card-value blue" id="p-pf">â€”</div><div class="card-sub">ganancia / pÃ©rdida bruta</div></div>
      <div class="card"><div class="card-title">Max drawdown</div><div class="card-value red" id="p-dd">â€”</div><div class="card-sub">desde mÃ¡ximo</div></div>
    </div>
    <div class="grid-3">
      <div class="card"><div class="card-title">Trade ganador medio</div><div class="card-value green" id="p-avgwin">â€”</div></div>
      <div class="card"><div class="card-title">Trade perdedor medio</div><div class="card-value red" id="p-avgloss">â€”</div></div>
      <div class="card"><div class="card-title">DuraciÃ³n media</div><div class="card-value yellow" id="p-dur">â€”</div><div class="card-sub">velas</div></div>
    </div>
    <div class="card" style="margin-bottom:16px">
      <div class="section-title" style="margin-bottom:14px">Curva de equity</div>
      <div style="height:240px"><canvas id="chart-equity"></canvas></div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="section-title" style="margin-bottom:14px">Rendimiento por par</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Par</th><th>Trades</th><th>Win %</th><th>PnL â‚¬</th></tr></thead>
            <tbody id="perf-pairs-tbody"></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="section-title" style="margin-bottom:14px">Ãšltimos 10 trades</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Par</th><th>TF</th><th>Dir</th><th>Resultado</th><th>PnL â‚¬</th><th>Velas</th></tr></thead>
            <tbody id="perf-recent-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• MONITOR â•â•â•â•â•â•â•â•â•â• -->
<div id="page-monitor" class="page">
  <div class="section-header" style="margin-bottom:16px">
    <span class="section-title">ğŸ“¶ Monitor de datos</span>
    <div style="display:flex;gap:10px;align-items:center">
      <span id="mon-server-time" style="color:var(--muted);font-size:12px"></span>
      <button class="btn btn-ghost" onclick="loadMonitor()">â†» Actualizar</button>
      <label style="display:flex;align-items:center;gap:6px;color:var(--muted);font-size:13px">
        <input type="checkbox" id="mon-auto" checked> Auto 30s
      </label>
    </div>
  </div>
  <div class="grid-4">
    <div class="card"><div class="card-title">Collector (OHLCV)</div><div class="card-value" id="mon-coll-health">â€”</div><div class="card-sub" id="mon-coll-total">â€” velas en BD</div></div>
    <div class="card"><div class="card-title">Features</div><div class="card-value" id="mon-feat-health">â€”</div><div class="card-sub" id="mon-feat-total">â€” features en BD</div></div>
    <div class="card"><div class="card-title">Ãšltima vela descargada</div><div class="card-value" style="font-size:16px" id="mon-last-candle">â€”</div></div>
    <div class="card"><div class="card-title">Ãšltimo feature calculado</div><div class="card-value" style="font-size:16px" id="mon-last-feature">â€”</div></div>
  </div>
  <div class="card" style="margin-bottom:16px">
    <div class="section-header"><span class="section-title">ğŸ“Š Datos OHLCV (Collector)</span></div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Par</th><th>TF</th><th>Ãšltima vela</th><th>AntigÃ¼edad</th><th>Filas</th><th>Estado</th></tr></thead>
        <tbody id="mon-ohlcv-tbody"></tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <div class="section-header"><span class="section-title">âš™ï¸ Features calculados</span></div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Par</th><th>TF</th><th>Ãšltimo feature</th><th>AntigÃ¼edad</th><th>Filas</th><th>Estado</th></tr></thead>
        <tbody id="mon-feat-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• MERCADO â•â•â•â•â•â•â•â•â•â• -->
<div id="page-market" class="page">
  <div class="section-header" style="margin-bottom:20px">
    <span class="section-title">ğŸŒ Mercado global</span>
    <button class="btn btn-ghost" onclick="loadMarket()">â†» Actualizar</button>
  </div>

  <!-- Sesiones de trading -->
  <div class="card" style="margin-bottom:20px">
    <div class="section-header" style="margin-bottom:8px">
      <span class="section-title">ğŸ•’ Sesiones de trading (UTC)</span>
      <span id="mkt-current-time" style="color:var(--muted);font-size:12px"></span>
    </div>
    <p style="color:var(--muted);font-size:12px;margin-bottom:16px">
      Las zonas de solapamiento (Londonâ€“New York, Tokyoâ€“London) suelen tener mayor volumen y volatilidad.
    </p>
    <div class="sessions-timeline" id="sessions-container"></div>

    <div style="margin-top:20px">
      <table>
        <thead><tr>
          <th>SesiÃ³n</th><th>Apertura (UTC)</th><th>Cierre (UTC)</th>
          <th>DuraciÃ³n</th><th>Pares principales</th><th>Estado</th>
        </tr></thead>
        <tbody id="sessions-table-tbody"></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:16px;background:#0d1117;border:1px solid var(--border)">
      <div style="font-size:13px;font-weight:600;margin-bottom:10px">ğŸ“ˆ Zonas de alto volumen (solapamientos)</div>
      <div class="grid-2" style="margin-bottom:0">
        <div>
          <span style="color:var(--yellow);font-weight:600">London â€“ New York</span>
          <span style="color:var(--muted);font-size:12px;display:block;margin-top:4px">
            13:00â€“17:00 UTC Â· 4 horas Â· MÃ¡xima liquidez del dÃ­a. Movimientos fuertes en EUR/USD, GBP/USD.
            Ideal para operaciones de breakout.
          </span>
        </div>
        <div>
          <span style="color:var(--yellow);font-weight:600">Tokyo â€“ London</span>
          <span style="color:var(--muted);font-size:12px;display:block;margin-top:4px">
            08:00â€“09:00 UTC Â· 1 hora Â· TransiciÃ³n Asiaâ†’Europa. Posibles gaps y movimientos en EUR/JPY, GBP/JPY.
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Correlaciones -->
  <div class="card" style="margin-bottom:20px">
    <div class="section-header" style="margin-bottom:8px">
      <div>
        <span class="section-title">ğŸ”— Matriz de correlaciones</span>
        <span style="color:var(--muted);font-size:12px;margin-left:12px" id="corr-info"></span>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <select id="corr-tf">
          <option>M15</option><option value="H1" selected>H1</option><option>H4</option><option>D1</option>
        </select>
        <select id="corr-days">
          <option value="30">30 dÃ­as</option><option value="90" selected>90 dÃ­as</option>
          <option value="180">180 dÃ­as</option><option value="365">1 aÃ±o</option>
        </select>
        <button class="btn btn-ghost" onclick="loadCorrelations()">Calcular</button>
      </div>
    </div>
    <p style="color:var(--muted);font-size:12px;margin-bottom:16px">
      Basada en retornos logarÃ­tmicos. Verde = correlaciÃ³n positiva (se mueven juntos), rojo = negativa (opuestos).
      La segunda lÃ­nea muestra la correlaciÃ³n reciente (Ãºltimos 20 periodos) para detectar cambios de rÃ©gimen.
    </p>
    <div class="table-wrap" id="corr-matrix-container">
      <div class="empty-state">Cargando correlaciones...</div>
    </div>
    <div class="corr-legend">
      <span>-1.0</span>
      <div class="corr-legend-bar"></div>
      <span>+1.0</span>
      <span style="margin-left:16px">ğŸŸ¢ Fuerte positiva &nbsp; ğŸ”´ Fuerte negativa &nbsp; âšª Neutral</span>
    </div>
  </div>

  <!-- Top correlaciones -->
  <div class="card">
    <div class="section-title" style="margin-bottom:14px">ğŸ† Ranking de correlaciones</div>
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Par 1</th><th>Par 2</th><th>CorrelaciÃ³n (perÃ­odo)</th>
          <th>CorrelaciÃ³n (reciente)</th><th>Cambio</th><th>InterpretaciÃ³n</th>
        </tr></thead>
        <tbody id="corr-ranking-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• TRAIN â•â•â•â•â•â•â•â•â•â• -->
<div id="page-train" class="page">
  <div class="section-header" style="margin-bottom:20px">
    <div style="display:flex;align-items:center;gap:16px">
      <span class="section-title">ğŸ§  Entrenamiento de modelos</span>
      <span id="train-badge" class="train-status-badge train-inactive">âšª Inactivo</span>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <span id="train-elapsed" style="color:var(--muted);font-size:12px"></span>
      <button class="btn btn-ghost" onclick="loadTrain()">â†» Actualizar</button>
      <label style="display:flex;align-items:center;gap:6px;color:var(--muted);font-size:13px">
        <input type="checkbox" id="train-auto" checked> Auto 10s
      </label>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid-4">
    <div class="card">
      <div class="card-title">Progreso</div>
      <div class="card-value blue" id="train-progress-val">â€”</div>
      <div class="card-sub" id="train-progress-sub">modelos completados</div>
    </div>
    <div class="card">
      <div class="card-title">Modelo actual</div>
      <div class="card-value" id="train-current" style="font-size:18px">â€”</div>
      <div class="card-sub" id="train-current-sub"></div>
    </div>
    <div class="card">
      <div class="card-title">Ã‰poca / Fold actual</div>
      <div class="card-value yellow" id="train-epoch">â€”</div>
      <div class="card-sub" id="train-epoch-sub"></div>
    </div>
    <div class="card">
      <div class="card-title">Modelos en disco</div>
      <div class="card-value purple" id="train-files-count">â€”</div>
      <div class="card-sub">archivos en models/saved/</div>
    </div>
  </div>

  <!-- Barra de progreso -->
  <div class="card" style="margin-bottom:16px">
    <div class="section-title" style="margin-bottom:12px">Progreso global</div>
    <div class="train-progress-outer">
      <div class="train-progress-inner" id="train-progress-bar" style="width:0%;background:var(--blue)">0%</div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px;color:var(--muted)">
      <span id="train-progress-label">0 / 30 modelos</span>
      <span id="train-started-label"></span>
    </div>
  </div>

  <!-- Modelo actual detallado -->
  <div class="card" style="margin-bottom:16px" id="train-current-card">
    <div class="section-title" style="margin-bottom:12px">ğŸ“¡ Modelo en entrenamiento</div>
    <div class="train-model-card" id="train-current-detail">
      <div style="text-align:center;color:var(--muted)">Esperando datos...</div>
    </div>
  </div>

  <div class="grid-2">
    <!-- Modelos completados -->
    <div class="card">
      <div class="section-title" style="margin-bottom:12px">âœ… Completados en esta sesiÃ³n</div>
      <div class="completed-grid" id="train-completed">
        <div style="color:var(--muted);font-size:13px">NingÃºn modelo completado aÃºn</div>
      </div>
    </div>

    <!-- Archivos recientes -->
    <div class="card">
      <div class="section-title" style="margin-bottom:12px">ğŸ“ Modelos recientes en disco</div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Archivo</th><th>TamaÃ±o</th><th>Modificado</th></tr></thead>
          <tbody id="train-files-tbody">
            <tr><td colspan="3" style="color:var(--muted);text-align:center">â€”</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Errores -->
  <div class="card" style="margin-bottom:16px;display:none" id="train-errors-card">
    <div class="section-title" style="margin-bottom:12px;color:var(--red)">ğŸ›‘ Errores detectados</div>
    <div class="train-log" id="train-errors-log"></div>
  </div>

  <!-- Log en vivo -->
  <div class="card">
    <div class="section-header">
      <span class="section-title">ğŸ“ Log en vivo (journalctl)</span>
      <span style="color:var(--muted);font-size:11px">Ãšltimas 50 lÃ­neas</span>
    </div>
    <div class="train-log" id="train-log"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• BOT CONFIG â•â•â•â•â•â•â•â•â•â• -->
<div id="page-bot" class="page">
  <div class="card" style="max-width:800px">
    <div class="section-header">
      <span class="section-title">ğŸ¤– ConfiguraciÃ³n del Bot</span>
    </div>
    <p style="color:var(--muted);font-size:13px;margin-bottom:28px">
      ParÃ¡metros generales del sistema de trading. Los cambios se guardan en disco y persisten entre reinicios del servidor.
    </p>

    <div class="bot-section">
      <div class="bot-section-title">Pares activos</div>
      <div class="chip-group" id="bot-pairs">
        <button class="chip active" data-v="EURUSD" onclick="toggleChip(this)">EURUSD</button>
        <button class="chip active" data-v="GBPUSD" onclick="toggleChip(this)">GBPUSD</button>
        <button class="chip active" data-v="USDJPY" onclick="toggleChip(this)">USDJPY</button>
        <button class="chip active" data-v="EURJPY" onclick="toggleChip(this)">EURJPY</button>
        <button class="chip active" data-v="XAUUSD" onclick="toggleChip(this)">XAUUSD</button>
      </div>
    </div>

    <div class="bot-section">
      <div class="bot-section-title">Timeframes activos</div>
      <div class="chip-group" id="bot-timeframes">
        <button class="chip active" data-v="M15" onclick="toggleChip(this)">M15</button>
        <button class="chip active" data-v="H1"  onclick="toggleChip(this)">H1</button>
        <button class="chip active" data-v="H4"  onclick="toggleChip(this)">H4</button>
      </div>
    </div>

    <div class="bot-section">
      <div class="bot-section-title">GestiÃ³n de riesgo</div>
      <div class="config-grid">
        <div class="field"><label>Riesgo por trade (%)</label>
          <input type="number" id="bot-risk" min="0.1" max="5" step="0.1" value="1.0"></div>
        <div class="field"><label>Lote mÃ¡ximo</label>
          <input type="number" id="bot-maxlot" min="0.01" max="1" step="0.01" value="0.10"></div>
        <div class="field"><label>Posiciones simultÃ¡neas mÃ¡x.</label>
          <input type="number" id="bot-maxpos" min="1" max="10" step="1" value="3"></div>
        <div class="field"><label>PÃ©rdida diaria mÃ¡xima (â‚¬)</label>
          <input type="number" id="bot-maxloss" min="0" max="500" step="5" value="50"></div>
      </div>
    </div>

    <div class="bot-section">
      <div class="bot-section-title">AutomatizaciÃ³n</div>
      <div class="config-grid">
        <div class="field"><label>Pausa fines de semana</label>
          <div class="field-toggle">
            <div class="toggle on" id="bot-weekend" onclick="toggleField('bot-weekend')"></div>
            <span id="bot-weekend-label" style="color:var(--muted)">SÃ­</span>
          </div>
          <span style="font-size:11px;color:var(--muted)">No descarga datos SÃ¡b-Dom cuando el mercado forex estÃ¡ cerrado</span>
        </div>
        <div class="field"><label>DÃ­a de reentrenamiento</label>
          <select id="bot-trainday">
            <option value="monday">Lunes</option><option value="tuesday">Martes</option>
            <option value="wednesday">MiÃ©rcoles</option><option value="thursday">Jueves</option>
            <option value="friday">Viernes</option><option value="saturday">SÃ¡bado</option>
            <option value="sunday" selected>Domingo</option>
          </select>
        </div>
        <div class="field"><label>Hora de reentrenamiento (UTC)</label>
          <input type="number" id="bot-trainhour" min="0" max="23" step="1" value="2"></div>
      </div>
    </div>

    <div class="bot-section">
      <div class="bot-section-title">Notas</div>
      <div class="field">
        <textarea id="bot-notes" rows="3" style="width:100%;background:var(--surface);border:1px solid var(--border);
          color:var(--text);border-radius:var(--radius);padding:10px;font-size:13px;resize:vertical;font-family:inherit"
          placeholder="Notas libres sobre la configuraciÃ³n actualâ€¦"></textarea>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
      <button class="btn btn-primary" onclick="saveBotConfig()">ğŸ’¾ Guardar configuraciÃ³n</button>
      <button class="btn btn-ghost" onclick="loadBotConfig()">â†» Recargar</button>
      <span class="save-msg" id="bot-save-msg">âœ… Guardado correctamente</span>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• SEÃ‘ALES CONFIG â•â•â•â•â•â•â•â•â•â• -->
<div id="page-config" class="page">
  <div class="card" style="max-width:700px">
    <div class="section-header">
      <span class="section-title">Filtros del generador de seÃ±ales</span>
    </div>
    <p style="color:var(--muted);font-size:13px;margin-bottom:24px">
      ParÃ¡metros aplicados en tiempo real a las nuevas seÃ±ales. El cambio es inmediato y se mantiene mientras el servidor estÃ© activo.
    </p>
    <div class="config-grid">
      <div class="field"><label>Confianza mÃ­nima (%)</label>
        <input type="number" id="cfg-confidence" min="50" max="99" step="1" value="54"></div>
      <div class="field"><label>ADX mÃ­nimo</label>
        <input type="number" id="cfg-adx" min="0" max="100" step="1" value="20"></div>
      <div class="field"><label>R:R mÃ­nimo</label>
        <input type="number" id="cfg-rr" min="1" max="5" step="0.1" value="1.5"></div>
      <div class="field"><label>Cooldown (velas)</label>
        <input type="number" id="cfg-cooldown" min="0" max="20" step="1" value="3"></div>
      <div class="field"><label>Multiplicador TP (Ã— ATR)</label>
        <input type="number" id="cfg-tp" min="1" max="5" step="0.1" value="2.0"></div>
      <div class="field"><label>Multiplicador SL (Ã— ATR)</label>
        <input type="number" id="cfg-sl" min="0.5" max="3" step="0.1" value="1.0"></div>
      <div class="field"><label>Permitir fuera de sesiÃ³n</label>
        <div class="field-toggle">
          <div class="toggle" id="cfg-offmarket" onclick="toggleField('cfg-offmarket')"></div>
          <span id="cfg-offmarket-label" style="color:var(--muted)">No</span>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:12px;align-items:center;margin-top:28px">
      <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ Guardar cambios</button>
      <button class="btn btn-ghost" onclick="loadConfig()">â†» Recargar</button>
      <span class="save-msg" id="save-msg">âœ… Guardado correctamente</span>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• BACKTEST â•â•â•â•â•â•â•â•â•â• -->
<div id="page-backtest" class="page">
  <div class="section-header" style="margin-bottom:16px">
    <span class="section-title">ğŸ¯ Backtesting Visual</span>
    <span style="color:var(--muted);font-size:12px" id="bt-signal-info"></span>
  </div>

  <!-- Config bar -->
  <div class="bt-config">
    <div class="bt-field">
      <label>Pares</label>
      <select id="bt-pairs" multiple>
        <option value="EURUSD" selected>EURUSD</option>
        <option value="GBPUSD" selected>GBPUSD</option>
        <option value="USDJPY" selected>USDJPY</option>
        <option value="EURJPY" selected>EURJPY</option>
        <option value="XAUUSD" selected>XAUUSD</option>
      </select>
    </div>
    <div class="bt-field">
      <label>Timeframes</label>
      <select id="bt-tfs" multiple>
        <option value="M15" selected>M15</option>
        <option value="H1" selected>H1</option>
        <option value="H4" selected>H4</option>
      </select>
    </div>
    <div class="bt-field">
      <label>DÃ­as</label>
      <input type="number" id="bt-days" value="90" min="7" max="365" style="width:80px">
    </div>
    <div class="bt-field">
      <label>Confianza mÃ­n.</label>
      <input type="number" id="bt-conf" value="54" min="50" max="95" step="1" style="width:80px">
      <span style="font-size:10px;color:var(--muted)">%</span>
    </div>
    <button class="bt-run-btn" id="bt-run-btn" onclick="runBacktest()">â–¶ Ejecutar Backtest</button>
  </div>

  <!-- Results -->
  <div id="bt-results" class="bt-results">
    <!-- KPIs -->
    <div class="bt-kpi-grid">
      <div class="bt-kpi"><div class="kpi-val" id="bt-k-trades">-</div><div class="kpi-label">Trades</div></div>
      <div class="bt-kpi"><div class="kpi-val" id="bt-k-wr">-</div><div class="kpi-label">Win Rate</div></div>
      <div class="bt-kpi"><div class="kpi-val" id="bt-k-pnl">-</div><div class="kpi-label">PnL Total</div></div>
      <div class="bt-kpi"><div class="kpi-val" id="bt-k-pf">-</div><div class="kpi-label">Profit Factor</div></div>
      <div class="bt-kpi"><div class="kpi-val" id="bt-k-dd">-</div><div class="kpi-label">Max Drawdown</div></div>
      <div class="bt-kpi"><div class="kpi-val" id="bt-k-exp">-</div><div class="kpi-label">Expectancy</div></div>
    </div>

    <!-- Equity + Drawdown -->
    <div class="bt-charts-row">
      <div class="bt-chart-card">
        <h4>ğŸ“ˆ Curva de Equity</h4>
        <canvas id="bt-equity-chart" height="220"></canvas>
      </div>
      <div class="bt-chart-card">
        <h4>ğŸ“‰ Drawdown</h4>
        <canvas id="bt-dd-chart" height="220"></canvas>
      </div>
    </div>

    <!-- Breakdowns -->
    <div class="bt-breakdown-row">
      <div class="bt-chart-card">
        <h4>ğŸ“Š PnL por Par</h4>
        <canvas id="bt-pair-chart" height="200"></canvas>
      </div>
      <div class="bt-chart-card">
        <h4>â±ï¸ PnL por Timeframe</h4>
        <canvas id="bt-tf-chart" height="200"></canvas>
      </div>
      <div class="bt-chart-card">
        <h4>ğŸ“… PnL por Mes</h4>
        <canvas id="bt-month-chart" height="200"></canvas>
      </div>
    </div>

    <!-- Win/Loss distribution -->
    <div class="bt-charts-row">
      <div class="bt-chart-card">
        <h4>ğŸ² DistribuciÃ³n Wins vs Losses vs Timeouts</h4>
        <canvas id="bt-dist-chart" height="160"></canvas>
      </div>
      <div class="bt-chart-card">
        <h4>ğŸ’° Avg Win vs Avg Loss</h4>
        <canvas id="bt-avg-chart" height="160"></canvas>
      </div>
    </div>

    <!-- Trades table -->
    <div class="section-header" style="margin:20px 0 10px">
      <span class="section-title" style="font-size:14px">ğŸ“ Trades Individuales</span>
      <span style="color:var(--muted);font-size:12px" id="bt-trades-count"></span>
    </div>
    <div class="bt-trades-wrap">
      <table class="bt-trades-table">
        <thead>
          <tr>
            <th>Fecha</th><th>Par</th><th>TF</th><th>Dir</th><th>Conf.</th>
            <th>Entry</th><th>Exit</th><th>Resultado</th>
            <th>Pips</th><th>PnL â‚¬</th><th>Lotes</th><th>Barras</th>
          </tr>
        </thead>
        <tbody id="bt-trades-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Empty state -->
  <div id="bt-empty" class="bt-empty">
    <div class="icon">ğŸ¯</div>
    <div style="font-size:16px;font-weight:600;margin-bottom:8px">Backtesting Visual</div>
    <div>Selecciona pares, timeframes y perÃ­odo, luego pulsa <strong>Ejecutar Backtest</strong>.</div>
    <div style="margin-top:8px;font-size:12px" id="bt-availability"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• DOCS â•â•â•â•â•â•â•â•â•â• -->
<div id="page-docs" class="page">
  <div class="section-header" style="margin-bottom:20px">
    <span class="section-title">ğŸ“š DocumentaciÃ³n del Proyecto</span>
    <span style="color:var(--muted);font-size:12px" id="docs-count"></span>
  </div>
  <div class="docs-layout">
    <div class="docs-sidebar" id="docs-sidebar">
      <div style="color:var(--muted);font-size:13px;padding:12px">Cargando documentos...</div>
    </div>
    <div class="docs-content">
      <div class="md-body" id="docs-rendered">
        <div style="color:var(--muted);text-align:center;padding:60px 20px">
          <div style="font-size:48px;margin-bottom:16px">ğŸ“š</div>
          <div style="font-size:16px;font-weight:600;margin-bottom:8px">DocumentaciÃ³n ML-Ayram</div>
          <div>Selecciona un documento de la lista para leerlo aquÃ­.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== ALERTS PAGE ========== -->
<div id="page-alerts" class="page">
  <div class="section-header" style="margin-bottom:20px">
    <span class="section-title">ğŸ”” Alertas y Notificaciones</span>
  </div>

  <div class="alerts-tabs">
    <button class="alerts-tab active" onclick="switchAlertsTab('history',this)">ğŸ“¬ Historial</button>
    <button class="alerts-tab" onclick="switchAlertsTab('rules',this)">âš™ï¸ Reglas</button>
  </div>

  <!-- PANEL 1: Historial -->
  <div id="alerts-history" class="alerts-panel active">
    <div class="notif-stats" id="notif-stats"></div>
    <div class="notif-filters">
      <div class="nf-field">
        <label>Tipo</label>
        <select id="nf-type" onchange="loadNotifications()">
          <option value="">Todos</option>
          <option value="signal">SeÃ±al</option>
          <option value="training">Training</option>
          <option value="anomaly">AnomalÃ­a</option>
          <option value="heartbeat">Heartbeat</option>
          <option value="error">Error</option>
          <option value="summary">Resumen</option>
          <option value="alert_rule">Regla alerta</option>
        </select>
      </div>
      <div class="nf-field">
        <label>Severidad</label>
        <select id="nf-severity" onchange="loadNotifications()">
          <option value="">Todas</option>
          <option value="info">Info</option>
          <option value="warning">Warning</option>
          <option value="high">High</option>
          <option value="critical">Critical</option>
        </select>
      </div>
      <div class="nf-field">
        <label>DÃ­as</label>
        <input type="number" id="nf-days" value="30" min="1" max="365" style="width:70px" onchange="loadNotifications()">
      </div>
      <div class="nf-field">
        <label>&nbsp;</label>
        <button onclick="loadNotifications()" style="padding:6px 14px;background:var(--blue);color:#fff;border:none;border-radius:var(--radius);cursor:pointer;font-size:12px">ğŸ”„ Refrescar</button>
      </div>
    </div>
    <div class="notif-wrap">
      <table class="notif-table">
        <thead><tr>
          <th>Fecha</th><th>Tipo</th><th>Sev.</th><th>TÃ­tulo</th><th>Par</th><th>Estado</th>
        </tr></thead>
        <tbody id="notif-tbody"></tbody>
      </table>
    </div>
    <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
      <span id="notif-total" style="font-size:12px;color:var(--muted)"></span>
      <div style="display:flex;gap:8px">
        <button id="notif-prev" onclick="notifPage(-1)" style="padding:4px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--muted);cursor:pointer;font-size:12px">â—€ Anterior</button>
        <button id="notif-next" onclick="notifPage(1)" style="padding:4px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--muted);cursor:pointer;font-size:12px">Siguiente â–¶</button>
      </div>
    </div>
  </div>

  <!-- PANEL 2: Reglas -->
  <div id="alerts-rules" class="alerts-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <span style="color:var(--muted);font-size:13px" id="rules-count"></span>
      <button onclick="toggleAddRule()" id="add-rule-toggle" style="padding:8px 16px;background:var(--blue);color:#fff;border:none;border-radius:var(--radius);cursor:pointer;font-size:13px;font-weight:600">â• Nueva regla</button>
    </div>

    <div id="add-rule-form" class="add-rule-form">
      <div style="font-weight:600;margin-bottom:12px;color:var(--text)">Nueva regla de alerta</div>
      <div class="add-rule-grid">
        <div class="arf">
          <label>Nombre</label>
          <input id="ar-name" placeholder="Ej: Drawdown alto">
        </div>
        <div class="arf">
          <label>Tipo de check</label>
          <select id="ar-type">
            <option value="signal_drought">SequÃ­a seÃ±ales</option>
            <option value="drawdown">Drawdown</option>
            <option value="low_winrate">Win rate bajo</option>
            <option value="stale_data">Datos obsoletos</option>
            <option value="stale_models">Modelos obsoletos</option>
          </select>
        </div>
        <div class="arf">
          <label>Par (opcional)</label>
          <select id="ar-pair">
            <option value="">Todos</option>
            <option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option>
            <option>EURJPY</option><option>XAUUSD</option>
          </select>
        </div>
        <div class="arf">
          <label>Umbral</label>
          <input id="ar-threshold" type="number" step="0.1" value="5">
        </div>
        <div class="arf">
          <label>Unidad</label>
          <select id="ar-unit">
            <option value="days">DÃ­as</option>
            <option value="percent">Porcentaje</option>
            <option value="hours">Horas</option>
          </select>
        </div>
        <div class="arf">
          <label>Severidad</label>
          <select id="ar-severity">
            <option value="warning">Warning</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
        <div class="arf">
          <label>Cooldown (h)</label>
          <input id="ar-cooldown" type="number" value="24" min="1">
        </div>
      </div>
      <div class="add-rule-btn">
        <button class="save" onclick="saveNewRule()">ğŸ’¾ Guardar</button>
        <button class="cancel" onclick="toggleAddRule()">Cancelar</button>
      </div>
    </div>

    <div id="rules-list"></div>
  </div>
</div>

<!-- â”€â”€ PÃ¡gina: Comparador de Modelos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="page-models" class="page">
  <div class="section-header" style="margin-bottom:20px">
    <span class="section-title">ğŸ§  Comparador de Modelos &mdash; XGBoost vs LSTM</span>
  </div>

  <div id="models-summary" class="models-summary"></div>

  <div class="models-filter">
    <select id="models-pair-filter" onchange="renderModels()">
      <option value="all">Todos los pares</option>
    </select>
    <select id="models-tf-filter" onchange="renderModels()">
      <option value="all">Todos los TF</option>
    </select>
    <button onclick="loadModels()" style="padding:8px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:13px">â†» Recargar</button>
  </div>

  <div id="models-grid" class="models-grid">
    <div class="card" style="text-align:center;padding:40px;grid-column:1/-1">
      <div style="color:var(--muted)">Cargando modelosâ€¦</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• JS â•â•â•â•â•â•â•â•â•â• -->
<script>
let _histCurrentPage = 1;
let _histTotalPages  = 1;
let _chartJsInstances = {};

// â”€â”€ NavegaciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  // Cerrar menÃº mÃ³vil al navegar
  document.querySelector('.nav-links')?.classList.remove('open');
  const loaders = {
    chart: loadChart, history: () => loadHistory(1), metrics: loadMetrics,
    performance: loadPerformance, monitor: loadMonitor, config: loadConfig,
    pipeline: loadPipeline, bot: loadBotConfig, market: loadMarket, train: loadTrain,
    backtest: loadBacktest, docs: loadDocs, alerts: loadAlerts, models: loadModels,
  };
  if (loaders[name]) loaders[name]();
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dirBadge(d) {
  if (d === 1)  return '<span class="badge badge-long">LONG</span>';
  if (d === -1) return '<span class="badge badge-short">SHORT</span>';
  return '<span class="badge badge-neut">NEU</span>';
}
function resultBadge(r) {
  if (r === 'tp_hit') return '<span class="badge badge-tp">TP âœ“</span>';
  if (r === 'sl_hit') return '<span class="badge badge-sl">SL âœ—</span>';
  return `<span class="badge badge-neut">${r}</span>`;
}
function pnlClass(v) { return v >= 0 ? 'pnl-pos' : 'pnl-neg'; }
function confBar(c) {
  const pct = Math.round((c ?? 0) * 100);
  return `<span class="conf-bar"><span class="conf-fill" style="width:${pct}%"></span></span> ${pct}%`;
}
function fmts(ts) {
  if (!ts || ts === 'None' || ts === 'NaT') return 'â€”';
  return new Date(ts).toLocaleString('es', {timeZone:'UTC', hour12:false}).replace(',','');
}
function fmtShort(ts) {
  if (!ts) return 'â€”';
  const d = new Date(ts);
  return d.toLocaleTimeString('es', {timeZone:'UTC', hour12:false, hour:'2-digit', minute:'2-digit'});
}
function fp(n, dec=5) { return n != null ? Number(n).toFixed(dec) : 'â€”'; }
function destroyChart(id) {
  if (_chartJsInstances[id]) { _chartJsInstances[id].destroy(); delete _chartJsInstances[id]; }
}
function mkChart(id, type, labels, datasets, extra={}) {
  destroyChart(id);
  const ctx = document.getElementById(id)?.getContext('2d');
  if (!ctx) return;
  _chartJsInstances[id] = new Chart(ctx, {
    type, data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#e6edf3', font: { size: 12 } } } },
      scales: (type !== 'pie' && type !== 'doughnut') ? {
        x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
        y: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
      } : {},
      ...extra,
    }
  });
}

function toggleField(id) {
  const el = document.getElementById(id);
  el.classList.toggle('on');
  const lbl = document.getElementById(id + '-label');
  if (lbl) lbl.textContent = el.classList.contains('on') ? 'SÃ­' : 'No';
}
function toggleChip(el) { el.classList.toggle('active'); }

// â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStatus() {
  try {
    const d = await fetch('/api/status').then(r => r.json());
    document.getElementById('status-text').textContent = 'Online Â· ' + new Date().toLocaleTimeString('es');
    document.getElementById('status-dot').style.background = 'var(--green)';
    document.getElementById('kpi-bars').textContent = d.total_bars?.toLocaleString() ?? 'â€”';
    document.getElementById('kpi-positions').textContent = d.open_positions ?? 'â€”';
  } catch {
    document.getElementById('status-dot').style.background = 'var(--red)';
    document.getElementById('status-text').textContent = 'Sin conexiÃ³n';
  }
}

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  await loadStatus();
  const data = await fetch('/api/signals/latest?limit=30').then(r => r.json()).catch(() => []);
  const todayUTC = new Date().toISOString().slice(0, 10);
  const valid = data.filter(s => s.filter_reason == null && s.direction !== 0);
  const today = valid.filter(s => s.timestamp && s.timestamp.startsWith(todayUTC));
  document.getElementById('kpi-today').textContent = today.length;
  if (valid.length) {
    const last = valid[0];
    const el = document.getElementById('kpi-last-dir');
    el.textContent = last.direction === 1 ? 'ğŸŸ¢ LONG' : 'ğŸ”´ SHORT';
    el.className = 'card-value ' + (last.direction === 1 ? 'green' : 'red');
    document.getElementById('kpi-last-ts').textContent = fmts(last.timestamp);
  }
  document.getElementById('latest-tbody').innerHTML = data.map(s => `
    <tr>
      <td>${fmts(s.timestamp)}</td><td><b>${s.pair}</b></td><td>${s.timeframe}</td>
      <td>${dirBadge(s.direction)}</td><td>${fp(s.entry_price)}</td>
      <td class="green">${fp(s.tp_price)}</td><td class="red">${fp(s.sl_price)}</td>
      <td>${s.rr_ratio?.toFixed(2) ?? 'â€”'}</td><td>${confBar(s.confidence)}</td>
      <td>${s.adx?.toFixed(1) ?? 'â€”'}</td><td>${s.session ?? 'â€”'}</td>
      <td>${s.filter_reason ? `<span style="color:var(--muted);font-size:11px">${s.filter_reason}</span>` : '<span style="color:var(--green)">âœ…</span>'}</td>
    </tr>`).join('');

  const positions = await fetch('/api/positions').then(r => r.ok ? r.json() : []).catch(() => []);
  const posArr = Array.isArray(positions) ? positions : [];
  const totalFloat = posArr.reduce((s, p) => s + (p.floating_pnl ?? 0), 0);
  document.getElementById('kpi-positions-pnl').textContent =
    posArr.length ? `PnL flotante: ${totalFloat >= 0 ? '+' : ''}${totalFloat.toFixed(2)}â‚¬` : 'Sin posiciones abiertas';
  document.getElementById('positions-tbody').innerHTML = posArr.length
    ? posArr.map(p => `
        <tr>
          <td><b>${p.pair}</b></td><td>${p.timeframe}</td><td>${dirBadge(p.direction)}</td>
          <td>${fp(p.entry_price)}</td><td>${p.current_price != null ? fp(p.current_price) : 'â€”'}</td>
          <td class="green">${fp(p.tp_price)}</td><td class="red">${fp(p.sl_price)}</td>
          <td>${p.lot_size}</td><td>${p.risk_amount?.toFixed(2) ?? 'â€”'}â‚¬</td>
          <td class="${pnlClass(p.floating_pnl ?? 0)}">${p.floating_pnl != null ? (p.floating_pnl >= 0 ? '+' : '') + p.floating_pnl.toFixed(2) + 'â‚¬' : 'â€”'}</td>
          <td>${fmts(p.opened_at)}</td>
        </tr>`).join('')
    : '<tr><td colspan="11" style="text-align:center;color:var(--muted);padding:20px">Sin posiciones abiertas</td></tr>';
}

// â”€â”€ Pipeline (barras de progreso) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TASK_DEFS = [
  { key: 'collector',  label: 'Collector (OHLCV)',      icon: 'ğŸ“¡', intervalMin: 15   },
  { key: 'features',   label: 'Features + Labels',      icon: 'âš™ï¸', intervalMin: 180  },
  { key: 'signals',    label: 'SeÃ±ales (daemon)',        icon: 'ğŸ“Š', intervalMin: 15   },
  { key: 'positions',  label: 'Posiciones',              icon: 'ğŸ’°', intervalMin: 5    },
  { key: 'anomaly',    label: 'AnomalÃ­as',               icon: 'ğŸ”', intervalMin: 360  },
  { key: 'train',      label: 'Entrenamiento',           icon: 'ğŸ§ ', intervalMin: 10080},
  { key: 'walkforward',label: 'Walk-forward',            icon: 'ğŸ“ˆ', intervalMin: 43200},
];

function isWeekendSlot(date) {
  const wd = date.getUTCDay(); // 0=Dom, 6=SÃ¡b
  const h  = date.getUTCHours();
  if (wd === 6) return true;                        // SÃ¡bado completo
  if (wd === 5 && h >= 22) return true;             // Viernes â‰¥22
  if (wd === 0 && h < 22) return true;              // Domingo <22
  return false;
}

function buildTimeSlots(hours, intervalMin) {
  const now    = new Date();
  const start  = new Date(now.getTime() - hours * 3600000);
  const slots  = [];
  // Alinear al inicio del intervalo
  const startMs = Math.ceil(start.getTime() / (intervalMin * 60000)) * (intervalMin * 60000);
  for (let t = startMs; t <= now.getTime(); t += intervalMin * 60000) {
    slots.push(new Date(t));
  }
  return slots;
}

function matchRunToSlot(slotTime, runs, intervalMin) {
  const slotMs  = slotTime.getTime();
  const halfInt = intervalMin * 60000 / 2;
  // Buscar un run dentro de Â±Â½ intervalo del slot
  for (const r of runs) {
    const rMs = new Date(r.started_at).getTime();
    if (Math.abs(rMs - slotMs) <= halfInt) return r;
  }
  return null;
}

async function loadPipeline() {
  const hours = parseInt(document.getElementById('pipe-hours').value);
  let data;
  try {
    const resp = await fetch(`/api/pipeline?hours=${hours}`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    data = await resp.json();
  } catch(e) {
    document.getElementById('pipeline-bars').innerHTML =
      `<div class="empty-state">âš ï¸ Endpoint /api/pipeline no disponible. Despliega la Ãºltima versiÃ³n de app.py.</div>`;
    document.getElementById('pipeline-stats-grid').innerHTML = '';
    document.getElementById('pipe-errors-tbody').innerHTML = '';
    return;
  }

  if (!data.runs || !Array.isArray(data.runs)) {
    document.getElementById('pipeline-bars').innerHTML =
      `<div class="empty-state">Sin datos de pipeline</div>`;
    return;
  }

  // Market badge
  const mb = document.getElementById('pipe-market-badge');
  if (data.market_open) {
    mb.textContent = 'ğŸŸ¢ Mercado abierto';
    mb.className = 'market-badge market-open';
  } else {
    mb.textContent = 'ğŸ”´ Mercado cerrado';
    mb.className = 'market-badge market-closed';
  }

  // Agrupar runs por tarea
  const runsByTask = {};
  for (const r of data.runs) {
    if (!runsByTask[r.task]) runsByTask[r.task] = [];
    runsByTask[r.task].push(r);
  }

  // Construir barras
  let barsHtml = '';
  for (const tdef of TASK_DEFS) {
    const taskRuns = runsByTask[tdef.key] || [];
    const stats    = data.stats[tdef.key] || {};
    const slots    = buildTimeSlots(hours, tdef.intervalMin);

    // Para tareas muy raras (train, walkforward), si no hay slots, mostrar resumen
    if (slots.length === 0) {
      barsHtml += `
        <div class="pipeline-task">
          <div class="pipeline-header">
            <span class="pipeline-label">${tdef.icon} ${tdef.label}</span>
            <div class="pipeline-stats">
              <span>âœ… ${stats.success ?? 0}</span>
              <span>âŒ ${stats.errors ?? 0}</span>
            </div>
          </div>
          <div style="color:var(--muted);font-size:12px;padding:6px 0">Sin ejecuciones esperadas en este perÃ­odo</div>
        </div>`;
      continue;
    }

    // Limitar a max 120 celdas visibles para legibilidad
    const maxCells = 120;
    const displaySlots = slots.length > maxCells ? slots.slice(slots.length - maxCells) : slots;

    let cellsHtml = '';
    for (const slot of displaySlots) {
      const run      = matchRunToSlot(slot, taskRuns, tdef.intervalMin);
      const weekend  = isWeekendSlot(slot);
      const isFuture = slot.getTime() > Date.now();

      let cls = 'pending';
      let tip = fmtShort(slot.toISOString()) + ' â€” Pendiente';

      if (isFuture) {
        cls = 'pending';
        tip = fmtShort(slot.toISOString()) + ' â€” Futuro';
      } else if (run) {
        cls = run.status;
        tip = fmtShort(run.started_at) + ' â€” ' +
              (run.status === 'success' ? `OK (${run.duration_seconds?.toFixed(1) ?? '?'}s)` :
               run.status === 'error'   ? `Error: ${(run.error_message || '').substring(0,60)}` :
               run.status === 'running' ? 'En cursoâ€¦' :
               run.status === 'skipped' ? `Saltado: ${(run.error_message || '').substring(0,40)}` : run.status);
      } else if (weekend) {
        cls = 'weekend';
        tip = fmtShort(slot.toISOString()) + ' â€” Mercado cerrado';
      }

      cellsHtml += `<div class="pipeline-cell ${cls}"><div class="pipeline-tooltip">${tip}</div></div>`;
    }

    // Horas de referencia debajo de la barra
    const firstSlot = displaySlots[0];
    const lastSlot  = displaySlots[displaySlots.length - 1];
    const midSlot   = displaySlots[Math.floor(displaySlots.length / 2)];

    barsHtml += `
      <div class="pipeline-task">
        <div class="pipeline-header">
          <span class="pipeline-label">${tdef.icon} ${tdef.label}</span>
          <div class="pipeline-stats">
            <span style="color:var(--green)">âœ… ${stats.success ?? 0}</span>
            <span style="color:var(--red)">âŒ ${stats.errors ?? 0}</span>
            ${stats.skipped ? `<span style="color:var(--muted)">â­ ${stats.skipped}</span>` : ''}
            ${stats.avg_duration ? `<span>â± ${stats.avg_duration}s</span>` : ''}
          </div>
        </div>
        <div class="pipeline-bar">${cellsHtml}</div>
        <div class="pipeline-hours">
          <span>${fmtShort(firstSlot.toISOString())}</span>
          <span>${fmtShort(midSlot.toISOString())}</span>
          <span>${fmtShort(lastSlot.toISOString())}</span>
        </div>
      </div>`;
  }

  document.getElementById('pipeline-bars').innerHTML = barsHtml;

  // Stats cards
  const statsGrid = document.getElementById('pipeline-stats-grid');
  statsGrid.innerHTML = TASK_DEFS.filter(t => data.stats[t.key]).map(t => {
    const s = data.stats[t.key];
    const rate = s.total > 0 ? Math.round(s.success / s.total * 100) : 0;
    const color = s.errors > 0 ? 'red' : rate >= 90 ? 'green' : 'yellow';
    return `
      <div class="card">
        <div class="card-title">${t.icon} ${t.label}</div>
        <div class="card-value ${color}">${rate}%</div>
        <div class="card-sub">${s.success}/${s.total} exitosos Â· ${s.errors} errores</div>
      </div>`;
  }).join('');

  // Error log
  document.getElementById('pipe-errors-tbody').innerHTML = data.errors.length
    ? data.errors.map(e => `
        <tr>
          <td>${fmts(e.started_at)}</td>
          <td><b>${e.task}</b></td>
          <td style="max-width:500px;overflow:hidden;text-overflow:ellipsis;color:var(--red)">${e.error_message || 'â€”'}</td>
          <td>${e.duration_seconds?.toFixed(1) ?? 'â€”'}s</td>
        </tr>`).join('')
    : '<tr><td colspan="4" style="text-align:center;color:var(--green);padding:20px">âœ… Sin errores recientes</td></tr>';
}

// â”€â”€ Mercado: Sesiones y Correlaciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const TRADING_SESSIONS = [
  { name: 'SÃ­dney',    color: '#58a6ff', openH: 22, closeH: 7,  pairs: 'AUD/USD, NZD/USD' },
  { name: 'Tokio',     color: '#bc8cff', openH: 0,  closeH: 9,  pairs: 'USD/JPY, EUR/JPY, AUD/JPY' },
  { name: 'London',    color: '#3fb950', openH: 8,  closeH: 17, pairs: 'EUR/USD, GBP/USD, EUR/GBP' },
  { name: 'New York',  color: '#f85149', openH: 13, closeH: 22, pairs: 'EUR/USD, GBP/USD, USD/CAD' },
];

function loadMarket() {
  renderSessions();
  loadCorrelations();
}

function renderSessions() {
  const now = new Date();
  const utcH = now.getUTCHours();
  const utcM = now.getUTCMinutes();
  const nowPct = ((utcH * 60 + utcM) / 1440) * 100;

  document.getElementById('mkt-current-time').textContent =
    `Ahora: ${String(utcH).padStart(2,'0')}:${String(utcM).padStart(2,'0')} UTC`;

  let html = '';

  // Fila de horas (se aÃ±ade fuera de session-row)
  let hourLabels = '';
  for (let h = 0; h < 24; h++) {
    hourLabels += `<span>${String(h).padStart(2,'0')}</span>`;
  }

  for (const s of TRADING_SESSIONS) {
    const wraps = s.openH > s.closeH; // cruza medianoche (ej: SÃ­dney 22â€“07)
    html += `<div class="session-row">`;
    html += `<div class="session-label" style="color:${s.color}">${s.name}</div>`;
    html += `<div class="session-track">`;

    if (wraps) {
      // Dos barras: openHâ€™24 y 0â†’closeH
      const pct1start = (s.openH / 24) * 100;
      const pct1width = ((24 - s.openH) / 24) * 100;
      const pct2width = (s.closeH / 24) * 100;
      html += `<div class="session-bar" style="left:${pct1start}%;width:${pct1width}%;background:${s.color}88">${s.openH}:00</div>`;
      html += `<div class="session-bar" style="left:0%;width:${pct2width}%;background:${s.color}88">${s.closeH}:00</div>`;
    } else {
      const left  = (s.openH / 24) * 100;
      const width = ((s.closeH - s.openH) / 24) * 100;
      html += `<div class="session-bar" style="left:${left}%;width:${width}%;background:${s.color}88">
                 ${s.openH}:00 â€“ ${s.closeH}:00</div>`;
    }

    // Indicador "ahora"
    html += `<div class="session-now" style="left:${nowPct}%"></div>`;
    html += `</div></div>`;
  }

  // Fila de horas de referencia (fuera de session-row para evitar height fijo)
  html += `<div class="session-hours">${hourLabels}</div>`;

  document.getElementById('sessions-container').innerHTML = html;

  // Tabla de sesiones
  const tbody = document.getElementById('sessions-table-tbody');
  tbody.innerHTML = TRADING_SESSIONS.map(s => {
    const wraps = s.openH > s.closeH;
    const dur = wraps ? (24 - s.openH + s.closeH) : (s.closeH - s.openH);

    // Â¿EstÃ¡ abierta ahora?
    let isOpen;
    if (wraps) {
      isOpen = utcH >= s.openH || utcH < s.closeH;
    } else {
      isOpen = utcH >= s.openH && utcH < s.closeH;
    }

    return `<tr>
      <td style="color:${s.color};font-weight:600">${s.name}</td>
      <td>${String(s.openH).padStart(2,'0')}:00</td>
      <td>${String(s.closeH).padStart(2,'0')}:00</td>
      <td>${dur}h</td>
      <td style="color:var(--muted);font-size:12px">${s.pairs}</td>
      <td>${isOpen
        ? '<span class="badge badge-tp">ğŸŸ¢ Abierta</span>'
        : '<span class="badge badge-neut">âšª Cerrada</span>'}</td>
    </tr>`;
  }).join('');
}

function corrColor(val) {
  // -1 = rojo intenso, 0 = neutro, +1 = verde intenso
  const abs = Math.abs(val);
  const alpha = Math.round(abs * 200 + 20);
  if (val > 0.01) return `rgba(63,185,80,${Math.min(alpha,255)/255})`;
  if (val < -0.01) return `rgba(248,81,73,${Math.min(alpha,255)/255})`;
  return 'transparent';
}

function corrInterpretation(val) {
  const a = Math.abs(val);
  if (a >= 0.8)  return val > 0 ? 'ğŸŸ¢ Muy fuerte +' : 'ğŸ”´ Muy fuerte â€“';
  if (a >= 0.5)  return val > 0 ? 'ğŸŸ¢ Fuerte +'    : 'ğŸ”´ Fuerte â€“';
  if (a >= 0.3)  return val > 0 ? 'ğŸŸ¡ Moderada +'  : 'ğŸŸ¡ Moderada â€“';
  return 'âšª DÃ©bil / sin correlaciÃ³n';
}

async function loadCorrelations() {
  const tf   = document.getElementById('corr-tf').value;
  const days = document.getElementById('corr-days').value;
  const container = document.getElementById('corr-matrix-container');
  container.innerHTML = '<div class="empty-state"><div class="spinner"></div> Calculando correlaciones...</div>';

  try {
    const resp = await fetch(`/api/correlations?timeframe=${tf}&days=${days}`);
    if (!resp.ok) {
      container.innerHTML = `<div class="empty-state">âš ï¸ Endpoint /api/correlations no disponible (HTTP ${resp.status}). Despliega la Ãºltima versiÃ³n de app.py.</div>`;
      return;
    }
    const data = await resp.json();
    if (data.error) {
      container.innerHTML = `<div class="empty-state">${data.error}</div>`;
      return;
    }

    document.getElementById('corr-info').textContent =
      `${data.data_points} periodos Â· ${tf} Â· ${days} dÃ­as`;

    const pairs = data.pairs;
    const mtx   = data.matrix;
    const rmtx  = data.recent_matrix;

    // Construir tabla
    let tbl = '<table class="corr-table"><thead><tr><th></th>';
    pairs.forEach(p => tbl += `<th>${p}</th>`);
    tbl += '</tr></thead><tbody>';

    pairs.forEach(p1 => {
      tbl += `<tr><th>${p1}</th>`;
      pairs.forEach(p2 => {
        const val     = mtx[p1]?.[p2] ?? 0;
        const recent  = rmtx[p1]?.[p2] ?? 0;
        const bg      = p1 === p2 ? '#21262d' : corrColor(val);
        const display = p1 === p2 ? '1.00' : val.toFixed(2);
        const rDisp   = p1 === p2 ? ''     : `<div style="font-size:10px;color:var(--muted);margin-top:2px">${recent.toFixed(2)}</div>`;

        tbl += `<td class="corr-cell" style="background:${bg}">${display}${rDisp}</td>`;
      });
      tbl += '</tr>';
    });
    tbl += '</tbody></table>';
    container.innerHTML = tbl;

    // Ranking
    const tbody = document.getElementById('corr-ranking-tbody');
    tbody.innerHTML = data.top_correlations.map(c => {
      const changeColor = c.change > 0.05 ? 'var(--green)' : c.change < -0.05 ? 'var(--red)' : 'var(--muted)';
      const arrow = c.change > 0.02 ? 'â†‘' : c.change < -0.02 ? 'â†“' : 'â†’';
      return `<tr>
        <td><b>${c.pair1}</b></td>
        <td><b>${c.pair2}</b></td>
        <td style="background:${corrColor(c.correlation)};text-align:center;font-weight:600">${c.correlation.toFixed(4)}</td>
        <td style="background:${corrColor(c.recent)};text-align:center;font-weight:600">${c.recent.toFixed(4)}</td>
        <td style="color:${changeColor};text-align:center">${arrow} ${c.change > 0 ? '+' : ''}${c.change.toFixed(4)}</td>
        <td>${corrInterpretation(c.correlation)}</td>
      </tr>`;
    }).join('');

  } catch(e) {
    container.innerHTML = `<div class="empty-state" style="color:var(--red)">Error: ${e.message}</div>`;
  }
}

// â”€â”€ Bot Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBotConfig() {
  try {
    const resp = await fetch('/api/bot');
    if (!resp.ok) {
      console.warn('Bot config endpoint no disponible (HTTP ' + resp.status + ')');
      return;
    }
    const cfg = await resp.json();
    if (!cfg || !cfg.active_pairs) return;

    // Pairs chips
    document.querySelectorAll('#bot-pairs .chip').forEach(ch => {
      ch.classList.toggle('active', cfg.active_pairs.includes(ch.dataset.v));
    });
    // TF chips
    document.querySelectorAll('#bot-timeframes .chip').forEach(ch => {
      ch.classList.toggle('active', cfg.active_timeframes.includes(ch.dataset.v));
    });
    // Fields
    document.getElementById('bot-risk').value    = cfg.risk_per_trade_pct;
    document.getElementById('bot-maxlot').value  = cfg.max_lot_size;
    document.getElementById('bot-maxpos').value  = cfg.max_simultaneous_positions;
    document.getElementById('bot-maxloss').value = cfg.max_daily_loss_eur;
    document.getElementById('bot-trainday').value  = cfg.training_day;
    document.getElementById('bot-trainhour').value = cfg.training_hour_utc;
    document.getElementById('bot-notes').value     = cfg.notes || '';

    const tog = document.getElementById('bot-weekend');
    cfg.weekend_pause ? tog.classList.add('on') : tog.classList.remove('on');
    document.getElementById('bot-weekend-label').textContent = cfg.weekend_pause ? 'SÃ­' : 'No';
  } catch(e) {
    console.error('Error loading bot config:', e);
  }
}

async function saveBotConfig() {
  const activePairs = [];
  document.querySelectorAll('#bot-pairs .chip.active').forEach(ch => activePairs.push(ch.dataset.v));
  const activeTFs = [];
  document.querySelectorAll('#bot-timeframes .chip.active').forEach(ch => activeTFs.push(ch.dataset.v));

  const body = {
    active_pairs:               activePairs,
    active_timeframes:          activeTFs,
    risk_per_trade_pct:         parseFloat(document.getElementById('bot-risk').value),
    max_lot_size:               parseFloat(document.getElementById('bot-maxlot').value),
    max_simultaneous_positions: parseInt(document.getElementById('bot-maxpos').value),
    max_daily_loss_eur:         parseFloat(document.getElementById('bot-maxloss').value),
    weekend_pause:              document.getElementById('bot-weekend').classList.contains('on'),
    training_day:               document.getElementById('bot-trainday').value,
    training_hour_utc:          parseInt(document.getElementById('bot-trainhour').value),
    notes:                      document.getElementById('bot-notes').value,
  };

  try {
    const res = await fetch('/api/bot', {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    if (res.ok) {
      const msg = document.getElementById('bot-save-msg');
      msg.style.display = 'inline';
      setTimeout(() => msg.style.display = 'none', 3000);
    } else {
      alert('Error guardando configuraciÃ³n: HTTP ' + res.status);
    }
  } catch(e) {
    alert('Error de conexiÃ³n: ' + e.message);
  }
}

// â”€â”€ GrÃ¡fico de velas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadChart() {
  const pair = document.getElementById('chart-pair').value;
  const tf   = document.getElementById('chart-tf').value;
  const bars = document.getElementById('chart-bars').value;
  const showSig = document.getElementById('show-signals').checked;
  const container = document.getElementById('chart-container');
  container.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%"><div class="spinner"></div></div>';
  try {
    const d = await fetch(`/api/chart/${pair}/${tf}?bars=${bars}`).then(r => r.json());
    if (d.detail) throw new Error(d.detail);
    container.innerHTML = '';
    const chart = LightweightCharts.createChart(container, {
      width: container.offsetWidth, height: 480,
      layout: { background: { color: '#161b22' }, textColor: '#e6edf3' },
      grid: { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
      rightPriceScale: { borderColor: '#30363d' },
      timeScale: { borderColor: '#30363d', timeVisible: true, secondsVisible: false },
    });
    // PrecisiÃ³n decimal: 5 para divisas, 3 para JPY, 2 para oro
    const precision = d.precision ?? 5;
    const minMove = precision === 5 ? 0.00001 : precision === 3 ? 0.001 : 0.01;
    const cs = chart.addCandlestickSeries({
      upColor:'#3fb950', downColor:'#f85149',
      borderUpColor:'#3fb950', borderDownColor:'#f85149',
      wickUpColor:'#3fb950', wickDownColor:'#f85149',
      priceFormat: { type: 'price', precision: precision, minMove: minMove },
    });
    cs.setData(d.candles.filter(c => c.open!=null && c.high!=null && c.low!=null && c.close!=null)
      .map(c => ({time:c.timestamp, open:c.open, high:c.high, low:c.low, close:c.close})));
    if (showSig && d.signals.length) {
      cs.setMarkers(d.signals.map(s => ({
        time: s.timestamp,
        position: s.direction===1?'belowBar':'aboveBar',
        color: s.direction===1?'#3fb950':'#f85149',
        shape: s.direction===1?'arrowUp':'arrowDown',
        text: `${s.direction===1?'â–²':'â–¼'} ${Number(s.confidence*100).toFixed(0)}%`,
      })));
      const last = d.signals[d.signals.length-1];
      if (last) {
        const t1 = d.candles[Math.max(0,d.candles.length-50)].timestamp;
        const t2 = d.candles[d.candles.length-1].timestamp;
        const pf = { type: 'price', precision: precision, minMove: minMove };
        const tp = chart.addLineSeries({color:'#3fb95077',lineWidth:1,lineStyle:2, priceFormat: pf});
        const sl = chart.addLineSeries({color:'#f8514977',lineWidth:1,lineStyle:2, priceFormat: pf});
        tp.setData([{time:t1,value:last.tp_price},{time:t2,value:last.tp_price}]);
        sl.setData([{time:t1,value:last.sl_price},{time:t2,value:last.sl_price}]);
      }
    }
    chart.timeScale().fitContent();
    window.addEventListener('resize', () => chart.applyOptions({width:container.offsetWidth}));
  } catch(e) {
    container.innerHTML = `<div style="padding:24px;color:var(--red)">Error: ${e.message}</div>`;
  }
}

// â”€â”€ Historial â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHistory(page) {
  _histCurrentPage = page;
  const pair = document.getElementById('hist-pair').value;
  const tf   = document.getElementById('hist-tf').value;
  const dir  = document.getElementById('hist-dir').value;
  const days = document.getElementById('hist-days').value;
  let url = `/api/signals/history?page=${page}&page_size=50&days=${days}`;
  if (pair) url += `&pair=${pair}`;
  if (tf)   url += `&timeframe=${tf}`;
  if (dir)  url += `&direction=${dir}`;
  const data = await fetch(url).then(r => r.json());
  _histTotalPages = data.pages;
  document.getElementById('hist-tbody').innerHTML = data.signals.map(s => `
    <tr>
      <td>${fmts(s.timestamp)}</td><td><b>${s.pair}</b></td><td>${s.timeframe}</td>
      <td>${dirBadge(s.direction)}</td><td>${fp(s.entry_price)}</td>
      <td class="green">${fp(s.tp_price)}</td><td class="red">${fp(s.sl_price)}</td>
      <td>${s.rr_ratio?.toFixed(2) ?? 'â€”'}</td>
      <td class="green">+${s.tp_pips?.toFixed(1) ?? 'â€”'}</td>
      <td class="red">-${s.sl_pips?.toFixed(1) ?? 'â€”'}</td>
      <td>${confBar(s.confidence)}</td>
      <td>${dirBadge(s.xgb_direction)}</td><td>${dirBadge(s.lstm_direction)}</td>
      <td>${s.adx?.toFixed(1) ?? 'â€”'}</td><td>${s.session ?? 'â€”'}</td>
    </tr>`).join('');
  document.getElementById('hist-page-info').textContent = `PÃ¡gina ${page} de ${data.pages} (${data.total} seÃ±ales)`;
  document.getElementById('hist-prev').disabled = page <= 1;
  document.getElementById('hist-next').disabled = page >= data.pages;
}
function histPage(d) { loadHistory(_histCurrentPage + d); }

// â”€â”€ MÃ©tricas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMetrics() {
  const pair = document.getElementById('met-pair').value;
  const tf   = document.getElementById('met-tf').value;
  const days = document.getElementById('met-days').value;
  let url = `/api/metrics?days=${days}`;
  if (pair) url += `&pair=${pair}`;
  if (tf)   url += `&timeframe=${tf}`;
  const m = await fetch(url).then(r => r.json());
  if (m.error) {
    ['m-total','m-conf','m-rr','m-agree'].forEach(id => document.getElementById(id).textContent = 'â€”');
    return;
  }
  document.getElementById('m-total').textContent = m.total_signals;
  document.getElementById('m-conf').textContent  = m.avg_confidence + '%';
  document.getElementById('m-rr').textContent    = m.avg_rr;
  document.getElementById('m-agree').textContent = m.agreement_pct + '%';
  mkChart('chart-dir','doughnut',['LONG','SHORT'],
    [{data:[m.long_signals,m.short_signals],backgroundColor:['#3fb950','#f85149']}]);
  mkChart('chart-pairs','bar',Object.keys(m.by_pair),
    [{label:'SeÃ±ales',data:Object.values(m.by_pair),backgroundColor:'#58a6ff88',borderColor:'#58a6ff',borderWidth:1}]);
  mkChart('chart-daily','bar',m.signals_by_day.map(d=>d.date),
    [{label:'SeÃ±ales/dÃ­a',data:m.signals_by_day.map(d=>d.count),backgroundColor:'#bc8cff88',borderColor:'#bc8cff',borderWidth:1}]);
  mkChart('chart-tf-dist','doughnut',Object.keys(m.by_timeframe),
    [{data:Object.values(m.by_timeframe),backgroundColor:['#58a6ff','#3fb950','#f85149']}]);
  const pairs = Object.keys(m.by_pair);
  mkChart('chart-pair-dir','bar',pairs,[
    {label:'LONG',data:pairs.map(()=>Math.round(m.long_pct)),backgroundColor:'#3fb95088'},
    {label:'SHORT',data:pairs.map(()=>Math.round(m.short_pct)),backgroundColor:'#f8514988'},
  ],{scales:{x:{stacked:true,ticks:{color:'#8b949e'},grid:{color:'#21262d'}},y:{stacked:true,ticks:{color:'#8b949e'},grid:{color:'#21262d'}}}});
}

// â”€â”€ Rendimiento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPerformance() {
  const pair = document.getElementById('perf-pair').value;
  const tf   = document.getElementById('perf-tf').value;
  const days = document.getElementById('perf-days').value;
  let url = `/api/performance?days=${days}`;
  if (pair) url += `&pair=${pair}`;
  if (tf)   url += `&timeframe=${tf}`;
  const p = await fetch(url).then(r => r.json());
  if (!p.trades || p.trades === 0) {
    document.getElementById('perf-empty').style.display = 'block';
    document.getElementById('perf-content').style.display = 'none';
    return;
  }
  document.getElementById('perf-empty').style.display = 'none';
  document.getElementById('perf-content').style.display = 'block';
  const pnlEl = document.getElementById('p-pnl');
  pnlEl.textContent = (p.total_pnl>=0?'+':'')+p.total_pnl.toFixed(2)+'â‚¬';
  pnlEl.className = 'card-value '+(p.total_pnl>=0?'green':'red');
  document.getElementById('p-trades').textContent  = `${p.trades} trades`;
  document.getElementById('p-wr').textContent      = p.win_rate+'%';
  document.getElementById('p-wl').textContent      = `${p.wins} âœ“ / ${p.losses} âœ—`;
  document.getElementById('p-pf').textContent      = p.profit_factor===Infinity?'âˆ':p.profit_factor;
  document.getElementById('p-dd').textContent      = p.max_drawdown.toFixed(2)+'â‚¬';
  document.getElementById('p-avgwin').textContent  = '+'+p.avg_win.toFixed(2)+'â‚¬';
  document.getElementById('p-avgloss').textContent = p.avg_loss.toFixed(2)+'â‚¬';
  document.getElementById('p-dur').textContent     = p.avg_duration_bars.toFixed(1);
  mkChart('chart-equity','line',p.equity_curve.map(d=>d.date),
    [{label:'Equity (â‚¬)',data:p.equity_curve.map(d=>d.cumulative),borderColor:'#58a6ff',backgroundColor:'#58a6ff22',fill:true,tension:.3,pointRadius:2}]);
  document.getElementById('perf-pairs-tbody').innerHTML = p.by_pair.map(row => `
    <tr><td><b>${row.pair}</b></td><td>${row.trades}</td><td>${row.win_rate.toFixed(1)}%</td>
    <td class="${pnlClass(row.pnl)}">${row.pnl>=0?'+':''}${row.pnl.toFixed(2)}â‚¬</td></tr>`).join('');
  document.getElementById('perf-recent-tbody').innerHTML = p.recent_trades.map(t => `
    <tr><td><b>${t.pair}</b></td><td>${t.timeframe}</td><td>${dirBadge(t.direction)}</td>
    <td>${resultBadge(t.result)}</td><td class="${pnlClass(t.pnl)}">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}â‚¬</td>
    <td>${t.duration_bars}</td></tr>`).join('');
}

// â”€â”€ Monitor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _monitorInterval = null;
function monStatusBadge(status) {
  const map = {
    ok:      '<span class="badge badge-tp">âœ… OK</span>',
    stale:   '<span class="badge" style="background:#d2992222;color:#d29922;border:1px solid #d2992244">âš ï¸ Retrasado</span>',
    critical:'<span class="badge badge-sl">ğŸ›‘ CrÃ­tico</span>',
    no_data: '<span class="badge badge-neut">â€” Sin datos</span>',
  };
  return map[status] || status;
}
function ageText(minutes) {
  if (minutes == null) return 'â€”';
  if (minutes < 60) return Math.round(minutes)+' min';
  if (minutes < 1440) return (minutes/60).toFixed(1)+' h';
  return (minutes/1440).toFixed(1)+' d';
}
function ageColor(status) {
  if (status==='ok') return 'color:var(--green)';
  if (status==='stale') return 'color:var(--yellow)';
  if (status==='critical') return 'color:var(--red)';
  return 'color:var(--muted)';
}
async function loadMonitor() {
  try {
    const d = await fetch('/api/monitor').then(r=>r.json());
    if (d.detail) throw new Error(d.detail);
    document.getElementById('mon-server-time').textContent = 'Servidor: '+fmts(d.server_time);
    const s = d.summary;
    document.getElementById('mon-coll-total').textContent = s.total_candles?.toLocaleString()+' velas en BD';
    document.getElementById('mon-feat-total').textContent = s.total_features?.toLocaleString()+' features en BD';
    document.getElementById('mon-last-candle').textContent = s.last_candle?fmts(s.last_candle):'â€”';
    document.getElementById('mon-last-feature').textContent = s.last_feature?fmts(s.last_feature):'â€”';
    const collEl = document.getElementById('mon-coll-health');
    collEl.textContent = s.collector_health;
    const ohlcvCrit = d.ohlcv.filter(r=>r.status==='critical').length;
    const ohlcvStale = d.ohlcv.filter(r=>r.status==='stale').length;
    collEl.className = 'card-value '+(ohlcvCrit>0?'red':ohlcvStale>0?'yellow':'green');
    const featEl = document.getElementById('mon-feat-health');
    featEl.textContent = s.features_health;
    const featCrit = d.features.filter(r=>r.status==='critical').length;
    const featStale = d.features.filter(r=>r.status==='stale').length;
    featEl.className = 'card-value '+(featCrit>0?'red':featStale>0?'yellow':'green');
    document.getElementById('mon-ohlcv-tbody').innerHTML = d.ohlcv.map(r=>`
      <tr><td><b>${r.pair}</b></td><td>${r.timeframe}</td>
      <td style="font-size:12px">${r.last_update?fmts(r.last_update):'â€”'}</td>
      <td style="${ageColor(r.status)}">${ageText(r.age_minutes)}</td>
      <td>${r.total_rows.toLocaleString()}</td><td>${monStatusBadge(r.status)}</td></tr>`).join('');
    document.getElementById('mon-feat-tbody').innerHTML = d.features.map(r=>`
      <tr><td><b>${r.pair}</b></td><td>${r.timeframe}</td>
      <td style="font-size:12px">${r.last_update?fmts(r.last_update):'â€”'}</td>
      <td style="${ageColor(r.status)}">${ageText(r.age_minutes)}</td>
      <td>${r.total_rows.toLocaleString()}</td><td>${monStatusBadge(r.status)}</td></tr>`).join('');
  } catch(e) {
    document.getElementById('mon-ohlcv-tbody').innerHTML =
      `<tr><td colspan="6" style="color:var(--red);padding:20px">Error: ${e.message}</td></tr>`;
  }
  clearInterval(_monitorInterval);
  if (document.getElementById('mon-auto')?.checked) {
    _monitorInterval = setInterval(()=>{
      if (document.getElementById('page-monitor').classList.contains('active')) loadMonitor();
      else clearInterval(_monitorInterval);
    }, 30000);
  }
}

// â”€â”€ Config seÃ±ales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Training monitor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _trainInterval = null;

async function loadTrain() {
  try {
    const resp = await fetch('/api/train/status');
    if (!resp.ok) {
      document.getElementById('train-log').textContent =
        `âš ï¸ Endpoint /api/train/status no disponible (HTTP ${resp.status}).\nDespliega la Ãºltima versiÃ³n de app.py.`;
      return;
    }
    const d = await resp.json();

    // Badge de estado
    const badge = document.getElementById('train-badge');
    if (d.service_status === 'active') {
      badge.className = 'train-status-badge train-running';
      badge.innerHTML = '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--blue);animation:pulse 1.5s infinite"></span> Entrenando';
    } else if (d.service_status === 'failed') {
      badge.className = 'train-status-badge train-failed';
      badge.textContent = 'âŒ Fallido';
    } else {
      badge.className = 'train-status-badge train-inactive';
      badge.textContent = 'âšª Inactivo';
    }

    // Elapsed
    document.getElementById('train-elapsed').textContent = d.elapsed ? `â± ${d.elapsed}` : '';

    // KPIs
    document.getElementById('train-progress-val').textContent = `${d.completed}/${d.total_models}`;
    document.getElementById('train-progress-sub').textContent = `${d.progress_pct}% completado`;
    document.getElementById('train-files-count').textContent = d.recent_files?.length || 0;

    // Current model KPI
    const curEl = document.getElementById('train-current');
    if (d.current_model) {
      curEl.textContent = `${d.current_model.type}`;
      document.getElementById('train-current-sub').textContent =
        `${d.current_model.pair} ${d.current_model.tf}` + (d.current_model.rows ? ` (${d.current_model.rows.toLocaleString()} filas)` : '');
    } else {
      curEl.textContent = d.service_status === 'active' ? 'Cargando...' : 'â€”';
      document.getElementById('train-current-sub').textContent = '';
    }

    // Epoch KPI
    const epochEl = document.getElementById('train-epoch');
    if (d.current_epoch) {
      if (d.current_epoch.epoch) {
        epochEl.textContent = `${d.current_epoch.epoch}/${d.current_epoch.total}`;
        document.getElementById('train-epoch-sub').textContent = `val_f1: ${d.current_epoch.val_f1?.toFixed(4) || 'â€”'}`;
      } else if (d.current_epoch.fold) {
        epochEl.textContent = `Fold ${d.current_epoch.fold}/${d.current_epoch.total}`;
        document.getElementById('train-epoch-sub').textContent = `F1: ${d.current_epoch.f1?.toFixed(4) || 'â€”'}`;
      }
    } else {
      epochEl.textContent = 'â€”';
      document.getElementById('train-epoch-sub').textContent = '';
    }

    // Progress bar
    const pBar = document.getElementById('train-progress-bar');
    pBar.style.width = `${Math.max(d.progress_pct, 2)}%`;
    pBar.textContent = `${d.progress_pct}%`;
    pBar.style.background = d.progress_pct >= 100 ? 'var(--green)' : 'var(--blue)';
    document.getElementById('train-progress-label').textContent = `${d.completed} / ${d.total_models} modelos`;
    document.getElementById('train-started-label').textContent = d.training_started ? `Inicio: ${d.training_started}` : '';

    // Current model card
    const detailEl = document.getElementById('train-current-detail');
    if (d.current_model) {
      const icon = d.current_model.type === 'LSTM' ? 'ğŸ§ ' : 'ğŸŒ²';
      let epochInfo = '';
      if (d.current_epoch) {
        if (d.current_epoch.epoch) {
          const epPct = Math.round(d.current_epoch.epoch / d.current_epoch.total * 100);
          epochInfo = `<div style="margin-top:8px"><div class="train-progress-outer" style="height:16px">
            <div class="train-progress-inner" style="width:${epPct}%;background:var(--yellow)">${d.current_epoch.epoch}/${d.current_epoch.total}</div>
          </div><div style="font-size:11px;color:var(--muted);margin-top:4px">val_f1: ${d.current_epoch.val_f1?.toFixed(4) || 'â€”'}</div></div>`;
        } else if (d.current_epoch.fold) {
          epochInfo = `<div style="margin-top:8px;font-size:12px;color:var(--muted)">Fold ${d.current_epoch.fold}/${d.current_epoch.total} â€” F1: <span style="color:var(--green)">${d.current_epoch.f1?.toFixed(4)}</span></div>`;
        }
      }
      detailEl.innerHTML = `
        <div class="train-model-icon">${icon}</div>
        <div class="train-model-info">
          <div class="train-model-name">${d.current_model.type} â€” ${d.current_model.pair} ${d.current_model.tf}</div>
          <div class="train-model-detail">${d.current_model.rows ? d.current_model.rows.toLocaleString() + ' filas de datos' : 'Cargando dataset...'}</div>
          ${epochInfo}
        </div>`;
    } else if (d.service_status === 'active') {
      detailEl.innerHTML = '<div style="color:var(--muted)">Preparando siguiente modelo...</div>';
    } else {
      detailEl.innerHTML = '<div style="color:var(--muted)">Servicio no activo</div>';
    }

    // Completed models
    const compEl = document.getElementById('train-completed');
    if (d.completed_models && d.completed_models.length > 0) {
      compEl.innerHTML = d.completed_models.map(m => {
        const icon = m.type === 'LSTM' ? 'ğŸ§ ' : 'ğŸŒ²';
        const f1 = m.f1 ? m.f1.toFixed(4) : 'â€”';
        return `<div class="completed-chip">
          <span class="chip-type">${icon} ${m.pair} ${m.tf}</span>
          <span class="chip-f1">F1: ${f1}</span>
        </div>`;
      }).join('');
    } else {
      compEl.innerHTML = '<div style="color:var(--muted);font-size:13px">NingÃºn modelo completado aÃºn</div>';
    }

    // Files table
    const tbody = document.getElementById('train-files-tbody');
    if (d.recent_files && d.recent_files.length > 0) {
      tbody.innerHTML = d.recent_files.map(f => {
        const mod = f.modified ? new Date(f.modified).toLocaleString() : 'â€”';
        const isRecent = f.modified && (Date.now() - new Date(f.modified).getTime()) < 3600000;
        return `<tr>
          <td style="font-size:11px;font-family:monospace">${f.name}${isRecent ? ' ğŸ†•' : ''}</td>
          <td>${f.size_kb} KB</td>
          <td style="font-size:11px">${mod}</td>
        </tr>`;
      }).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="3" style="color:var(--muted);text-align:center">Sin archivos</td></tr>';
    }

    // Errors
    const errCard = document.getElementById('train-errors-card');
    if (d.errors && d.errors.length > 0) {
      errCard.style.display = 'block';
      document.getElementById('train-errors-log').innerHTML =
        d.errors.map(e => `<span class="log-error">${e}</span>`).join('\n');
    } else {
      errCard.style.display = 'none';
    }

    // Log tail
    const logEl = document.getElementById('train-log');
    if (d.log_tail && d.log_tail.length > 0) {
      logEl.innerHTML = d.log_tail.map(line => {
        let cls = '';
        if (line.includes('ERROR') || line.includes('Traceback')) cls = 'log-error';
        else if (line.includes('guardado') || line.includes('completado') || line.includes('saved')) cls = 'log-success';
        else if (line.includes('WARNING') || line.includes('FutureWarning')) cls = 'log-warning';
        else if (line.includes('Epoch') || line.includes('Fold') || line.includes('[XGB]') || line.includes('[LSTM]')) cls = 'log-info';
        return cls ? `<span class="${cls}">${line}</span>` : line;
      }).join('\n');
      logEl.scrollTop = logEl.scrollHeight;
    } else {
      logEl.textContent = 'Sin logs disponibles';
    }

  } catch(e) {
    document.getElementById('train-log').textContent = `Error cargando estado: ${e.message}`;
  }

  // Auto-refresh
  clearInterval(_trainInterval);
  if (document.getElementById('train-auto')?.checked) {
    _trainInterval = setInterval(() => {
      if (document.getElementById('page-train').classList.contains('active')) loadTrain();
      else clearInterval(_trainInterval);
    }, 10000);
  }
}

// â”€â”€ Backtest visual â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _btCharts = {};   // Chart.js instances para destruir al re-render

async function loadBacktest() {
  // Cargar quick-stats para mostrar disponibilidad de seÃ±ales
  try {
    const resp = await fetch('/api/backtest/quick-stats');
    if (resp.ok) {
      const data = await resp.json();
      const avail = document.getElementById('bt-availability');
      if (data.has_signals) {
        const total = data.stats.reduce((s, r) => s + r.total, 0);
        const pairs = [...new Set(data.stats.map(r => r.pair))];
        avail.innerHTML = `<span style="color:var(--green)">âœ… ${total} seÃ±ales disponibles</span> en ${pairs.join(', ')}`;
        document.getElementById('bt-signal-info').textContent = `${total} seÃ±ales en BD`;
      } else {
        avail.innerHTML = '<span style="color:var(--yellow)">âš ï¸ Sin seÃ±ales en la BD todavÃ­a. Los modelos deben terminar de entrenarse y generar seÃ±ales primero.</span>';
        document.getElementById('bt-signal-info').textContent = 'Sin seÃ±ales';
      }
    }
  } catch(e) {
    document.getElementById('bt-availability').innerHTML = `<span style="color:var(--red)">Error: ${e.message}</span>`;
  }
}

async function runBacktest() {
  const btn = document.getElementById('bt-run-btn');
  btn.disabled = true;
  btn.classList.add('running');
  btn.textContent = 'â³ Ejecutando...';

  // Recoger config
  const pairs = Array.from(document.getElementById('bt-pairs').selectedOptions).map(o => o.value);
  const tfs = Array.from(document.getElementById('bt-tfs').selectedOptions).map(o => o.value);
  const days = parseInt(document.getElementById('bt-days').value) || 90;
  const conf = (parseInt(document.getElementById('bt-conf').value) || 54) / 100;

  try {
    const resp = await fetch('/api/backtest/run', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ pairs, timeframes: tfs, days, min_confidence: conf })
    });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
    const r = await resp.json();

    if (r.total_trades === 0) {
      document.getElementById('bt-results').classList.remove('visible');
      document.getElementById('bt-empty').style.display = 'block';
      document.getElementById('bt-availability').innerHTML =
        `<span style="color:var(--yellow)">âš ï¸ 0 trades simulados (${r.total_signals} seÃ±ales encontradas pero sin barras OHLCV forward). Verifica que hay datos suficientes.</span>`;
      return;
    }

    // Ocultar empty, mostrar results
    document.getElementById('bt-empty').style.display = 'none';
    document.getElementById('bt-results').classList.add('visible');

    renderBacktestResults(r);

  } catch(e) {
    alert('Error ejecutando backtest: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.classList.remove('running');
    btn.textContent = 'â–¶ Ejecutar Backtest';
  }
}

function renderBacktestResults(r) {
  // KPIs
  const pnlColor = r.total_pnl_eur >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('bt-k-trades').textContent = `${r.wins}W / ${r.losses}L / ${r.timeouts}T`;
  document.getElementById('bt-k-wr').innerHTML = `<span style="color:${r.win_rate >= 50 ? 'var(--green)' : 'var(--red)'}">${r.win_rate}%</span>`;
  document.getElementById('bt-k-pnl').innerHTML = `<span style="color:${pnlColor}">${r.total_pnl_eur >= 0 ? '+' : ''}${r.total_pnl_eur.toFixed(2)}â‚¬</span>`;
  document.getElementById('bt-k-pf').textContent = r.profit_factor != null ? r.profit_factor.toFixed(2) : 'âˆ';
  document.getElementById('bt-k-dd').innerHTML = `<span style="color:var(--red)">-${r.max_drawdown.toFixed(0)}â‚¬ (${r.max_drawdown_pct.toFixed(1)}%)</span>`;
  document.getElementById('bt-k-exp').innerHTML = `<span style="color:${r.expectancy >= 0 ? 'var(--green)' : 'var(--red)'}">${r.expectancy >= 0 ? '+' : ''}${r.expectancy.toFixed(2)}â‚¬</span>`;
  document.getElementById('bt-trades-count').textContent = `${r.total_trades} trades | ${r.date_from} â†’ ${r.date_to}`;

  // Destruir charts previos
  Object.values(_btCharts).forEach(c => c.destroy());
  _btCharts = {};

  const chartOpts = {
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      x: { ticks: { color: '#8b949e', font: { size: 10 } }, grid: { color: '#21262d' } },
      y: { ticks: { color: '#8b949e', font: { size: 10 } }, grid: { color: '#21262d' } }
    }
  };

  // Equity curve
  if (r.equity_curve && r.equity_curve.length > 0) {
    _btCharts.equity = new Chart(document.getElementById('bt-equity-chart'), {
      type: 'line',
      data: {
        labels: r.equity_curve.map(p => p.date),
        datasets: [{
          data: r.equity_curve.map(p => p.equity),
          borderColor: '#58a6ff', backgroundColor: '#58a6ff18',
          fill: true, tension: 0.3, pointRadius: r.equity_curve.length > 50 ? 0 : 3, borderWidth: 2
        }]
      },
      options: { ...chartOpts, plugins: { ...chartOpts.plugins, tooltip: {
        callbacks: { label: ctx => `${ctx.parsed.y.toFixed(2)}â‚¬` }
      }}}
    });

    // Drawdown chart
    _btCharts.dd = new Chart(document.getElementById('bt-dd-chart'), {
      type: 'line',
      data: {
        labels: r.equity_curve.map(p => p.date),
        datasets: [{
          data: r.equity_curve.map(p => -p.drawdown),
          borderColor: '#f85149', backgroundColor: '#f8514918',
          fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2
        }]
      },
      options: { ...chartOpts, plugins: { ...chartOpts.plugins, tooltip: {
        callbacks: { label: ctx => `${ctx.parsed.y.toFixed(2)}â‚¬` }
      }}}
    });
  }

  // PnL por par
  const pairLabels = Object.keys(r.by_pair || {});
  const pairPnl = pairLabels.map(p => r.by_pair[p].pnl_eur);
  const pairColors = pairPnl.map(v => v >= 0 ? '#3fb950' : '#f85149');
  _btCharts.pair = new Chart(document.getElementById('bt-pair-chart'), {
    type: 'bar',
    data: { labels: pairLabels, datasets: [{ data: pairPnl, backgroundColor: pairColors }] },
    options: chartOpts
  });

  // PnL por TF
  const tfLabels = Object.keys(r.by_timeframe || {});
  const tfPnl = tfLabels.map(t => r.by_timeframe[t].pnl_eur);
  const tfColors = tfPnl.map(v => v >= 0 ? '#3fb950' : '#f85149');
  _btCharts.tf = new Chart(document.getElementById('bt-tf-chart'), {
    type: 'bar',
    data: { labels: tfLabels, datasets: [{ data: tfPnl, backgroundColor: tfColors }] },
    options: chartOpts
  });

  // PnL por mes
  const monthLabels = Object.keys(r.by_month || {}).sort();
  const monthPnl = monthLabels.map(m => r.by_month[m].pnl_eur);
  const monthColors = monthPnl.map(v => v >= 0 ? '#3fb950' : '#f85149');
  _btCharts.month = new Chart(document.getElementById('bt-month-chart'), {
    type: 'bar',
    data: { labels: monthLabels, datasets: [{ data: monthPnl, backgroundColor: monthColors }] },
    options: chartOpts
  });

  // DistribuciÃ³n W/L/T (doughnut)
  _btCharts.dist = new Chart(document.getElementById('bt-dist-chart'), {
    type: 'doughnut',
    data: {
      labels: ['Wins', 'Losses', 'Timeouts'],
      datasets: [{ data: [r.wins, r.losses, r.timeouts],
        backgroundColor: ['#3fb950', '#f85149', '#8b949e'], borderWidth: 0 }]
    },
    options: { responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'right', labels: { color: '#c9d1d9', font: { size: 12 } } } }
    }
  });

  // Avg Win vs Loss (horizontal bar)
  _btCharts.avg = new Chart(document.getElementById('bt-avg-chart'), {
    type: 'bar',
    data: {
      labels: ['Avg Win', 'Avg Loss'],
      datasets: [{ data: [r.avg_win_eur, Math.abs(r.avg_loss_eur)],
        backgroundColor: ['#3fb950', '#f85149'] }]
    },
    options: { ...chartOpts, indexAxis: 'y' }
  });

  // Tabla de trades
  const tbody = document.getElementById('bt-trades-body');
  const trades = r.trades || [];
  tbody.innerHTML = trades.map(t => {
    const resIcon = t.result === 'tp_hit' ? 'âœ…' : t.result === 'sl_hit' ? 'âŒ' : 'â³';
    const resColor = t.result === 'tp_hit' ? 'var(--green)' : t.result === 'sl_hit' ? 'var(--red)' : 'var(--muted)';
    const dir = t.direction === 1 ? '<span style="color:var(--green)">LONG</span>' : '<span style="color:var(--red)">SHORT</span>';
    const pnlC = t.pnl_eur >= 0 ? 'var(--green)' : 'var(--red)';
    return `<tr>
      <td>${(t.opened_at || '').substring(0, 16)}</td>
      <td><strong>${t.pair}</strong></td>
      <td>${t.timeframe}</td>
      <td>${dir}</td>
      <td>${(t.confidence * 100).toFixed(0)}%</td>
      <td>${t.actual_entry}</td>
      <td>${t.exit_price}</td>
      <td style="color:${resColor}">${resIcon} ${t.result.replace('_', ' ')}</td>
      <td style="color:${pnlC}">${t.pnl_pips >= 0 ? '+' : ''}${t.pnl_pips}</td>
      <td style="color:${pnlC};font-weight:600">${t.pnl_eur >= 0 ? '+' : ''}${t.pnl_eur.toFixed(2)}â‚¬</td>
      <td>${t.lot_size}</td>
      <td>${t.bars_to_exit}</td>
    </tr>`;
  }).join('');
}

// â”€â”€ Documentation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _docsListCache = null;
let _currentDoc = null;

const DOC_ICONS = {
  'COMO_FUNCIONA': 'ğŸ“–',
  'TUTORIAL_COMPLETO': 'ğŸ› ï¸',
  'PROMPT_CONTINUIDAD': 'ğŸ¤–',
};
const DOC_DESCRIPTIONS = {
  'COMO_FUNCIONA': 'ExplicaciÃ³n detallada de todo el sistema',
  'TUTORIAL_COMPLETO': 'GuÃ­a paso a paso de implementaciÃ³n',
  'PROMPT_CONTINUIDAD': 'Prompt para continuidad con IA',
};

async function loadDocs() {
  try {
    // Cargar lista (cachear)
    if (!_docsListCache) {
      const resp = await fetch('/api/docs-list');
      if (!resp.ok) {
        document.getElementById('docs-sidebar').innerHTML =
          `<div style="color:var(--red);padding:12px">âš ï¸ Endpoint /api/docs no disponible (HTTP ${resp.status}). Despliega la Ãºltima versiÃ³n.</div>`;
        return;
      }
      _docsListCache = await resp.json();
    }
    const files = _docsListCache.files || [];
    document.getElementById('docs-count').textContent = `${files.length} documentos`;

    // Sidebar
    const sidebar = document.getElementById('docs-sidebar');
    sidebar.innerHTML = files.map(f => {
      const icon = DOC_ICONS[f.name] || 'ğŸ“„';
      const desc = DOC_DESCRIPTIONS[f.name] || f.filename;
      const mod = f.modified ? new Date(f.modified).toLocaleDateString('es') : '';
      const active = _currentDoc === f.filename ? ' active' : '';
      return `<div class="docs-file-btn${active}" onclick="loadDocContent('${f.filename}')">
        <div class="doc-name">${icon} ${f.name.replace(/_/g, ' ')}</div>
        <div class="doc-meta">${desc}</div>
        <div class="doc-meta">${f.size_kb} KB â€¢ ${mod}</div>
      </div>`;
    }).join('');

    // Auto-cargar el primero si no hay ninguno seleccionado
    if (!_currentDoc && files.length > 0) {
      // Preferir COMO_FUNCIONA
      const pref = files.find(f => f.name === 'COMO_FUNCIONA') || files[0];
      loadDocContent(pref.filename);
    }
  } catch(e) {
    document.getElementById('docs-sidebar').innerHTML =
      `<div style="color:var(--red);padding:12px">Error: ${e.message}</div>`;
  }
}

async function loadDocContent(filename) {
  _currentDoc = filename;
  const rendered = document.getElementById('docs-rendered');
  rendered.innerHTML = '<div style="color:var(--muted);text-align:center;padding:40px">Cargando...</div>';

  // Actualizar sidebar activo
  document.querySelectorAll('.docs-file-btn').forEach(btn => {
    btn.classList.toggle('active', btn.onclick.toString().includes(filename));
  });

  try {
    const resp = await fetch(`/api/docs-content/${encodeURIComponent(filename)}`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();

    // Renderizar markdown
    const html = marked.parse(data.content, {
      breaks: true,
      gfm: true,
    });
    rendered.innerHTML = html;

    // Scroll al top del contenido
    rendered.scrollTop = 0;
    document.querySelector('.docs-content').scrollTop = 0;
  } catch(e) {
    rendered.innerHTML = `<div style="color:var(--red);padding:20px">âŒ Error cargando ${filename}: ${e.message}</div>`;
  }

  // Re-render sidebar para marcar activo
  if (_docsListCache) {
    const files = _docsListCache.files || [];
    const sidebar = document.getElementById('docs-sidebar');
    sidebar.innerHTML = files.map(f => {
      const icon = DOC_ICONS[f.name] || 'ğŸ“„';
      const desc = DOC_DESCRIPTIONS[f.name] || f.filename;
      const mod = f.modified ? new Date(f.modified).toLocaleDateString('es') : '';
      const active = _currentDoc === f.filename ? ' active' : '';
      return `<div class="docs-file-btn${active}" onclick="loadDocContent('${f.filename}')">
        <div class="doc-name">${icon} ${f.name.replace(/_/g, ' ')}</div>
        <div class="doc-meta">${desc}</div>
        <div class="doc-meta">${f.size_kb} KB â€¢ ${mod}</div>
      </div>`;
    }).join('');
  }
}

// â”€â”€ Config seÃ±ales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadConfig() {
  const cfg = await fetch('/api/config').then(r=>r.json());
  document.getElementById('cfg-confidence').value = Math.round(cfg.min_confidence*100);
  document.getElementById('cfg-adx').value  = cfg.min_adx;
  document.getElementById('cfg-rr').value   = cfg.min_rr;
  document.getElementById('cfg-cooldown').value = cfg.cooldown_bars;
  document.getElementById('cfg-tp').value   = cfg.tp_multiplier;
  document.getElementById('cfg-sl').value   = cfg.sl_multiplier;
  const tog = document.getElementById('cfg-offmarket');
  cfg.allow_offmarket ? tog.classList.add('on') : tog.classList.remove('on');
  document.getElementById('cfg-offmarket-label').textContent = cfg.allow_offmarket?'SÃ­':'No';
}
async function saveConfig() {
  const body = {
    min_confidence:  parseFloat(document.getElementById('cfg-confidence').value)/100,
    min_adx:         parseFloat(document.getElementById('cfg-adx').value),
    min_rr:          parseFloat(document.getElementById('cfg-rr').value),
    cooldown_bars:   parseInt(document.getElementById('cfg-cooldown').value),
    tp_multiplier:   parseFloat(document.getElementById('cfg-tp').value),
    sl_multiplier:   parseFloat(document.getElementById('cfg-sl').value),
    allow_offmarket: document.getElementById('cfg-offmarket').classList.contains('on'),
  };
  const res = await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if (res.ok) {
    const msg = document.getElementById('save-msg');
    msg.style.display = 'inline';
    setTimeout(()=>msg.style.display='none', 3000);
  }
}

// â”€â”€ Alerts / Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _notifOffset = 0;
const _notifLimit = 50;

function switchAlertsTab(tab, btn) {
  document.querySelectorAll('.alerts-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.alerts-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('alerts-' + tab).classList.add('active');
  if (tab === 'history') loadNotifications();
  if (tab === 'rules') loadAlertRules();
}

async function loadAlerts() {
  loadNotifications();
  loadAlertRules();
}

// â”€â”€ Historial de notificaciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadNotifications() {
  _notifOffset = 0;
  await fetchNotifications();
}

function notifPage(dir) {
  _notifOffset = Math.max(0, _notifOffset + dir * _notifLimit);
  fetchNotifications();
}

async function fetchNotifications() {
  const type = document.getElementById('nf-type').value;
  const sev = document.getElementById('nf-severity').value;
  const days = document.getElementById('nf-days').value || 30;
  let url = `/api/notifications?days=${days}&limit=${_notifLimit}&offset=${_notifOffset}`;
  if (type) url += `&notif_type=${type}`;
  if (sev) url += `&severity=${sev}`;

  try {
    const r = await fetch(url).then(r => r.json());
    renderNotifStats(r.stats_by_type || {}, r.total || 0);
    renderNotifTable(r.notifications || []);
    const total = r.total || 0;
    document.getElementById('notif-total').textContent = `${total} notificaciones (mostrando ${Math.min(_notifOffset+1, total)}â€“${Math.min(_notifOffset+_notifLimit, total)})`;
    document.getElementById('notif-prev').disabled = _notifOffset === 0;
    document.getElementById('notif-next').disabled = _notifOffset + _notifLimit >= total;
  } catch(e) {
    document.getElementById('notif-tbody').innerHTML = `<tr><td colspan="6" style="color:var(--muted);text-align:center;padding:30px">Error cargando notificaciones</td></tr>`;
  }
}

const NOTIF_ICONS = { signal:'ğŸ“¡', training:'ğŸ‹ï¸', anomaly:'ğŸš¨', heartbeat:'ğŸ’“', error:'âŒ', summary:'ğŸ“‹', alert_rule:'ğŸ””' };

function renderNotifStats(stats, total) {
  const el = document.getElementById('notif-stats');
  let html = `<div class="notif-stat"><div class="ns-val">${total}</div><div class="ns-label">Total</div></div>`;
  for (const [type, cnt] of Object.entries(stats)) {
    html += `<div class="notif-stat"><div class="ns-val">${cnt}</div><div class="ns-label">${NOTIF_ICONS[type]||''} ${type}</div></div>`;
  }
  el.innerHTML = html;
}

function renderNotifTable(items) {
  const tbody = document.getElementById('notif-tbody');
  if (!items.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="color:var(--muted);text-align:center;padding:40px"><div style="font-size:36px;margin-bottom:8px">ğŸ”•</div>Sin notificaciones en este perÃ­odo</td></tr>';
    return;
  }
  tbody.innerHTML = items.map(n => {
    const d = new Date(n.created_at);
    const dateStr = d.toLocaleDateString('es', {day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
    const icon = NOTIF_ICONS[n.notif_type] || 'ğŸ“¨';
    return `<tr>
      <td style="white-space:nowrap;font-size:11px">${dateStr}</td>
      <td><span class="notif-badge ${n.notif_type}">${icon} ${n.notif_type}</span></td>
      <td><span class="sev-badge ${n.severity}">${n.severity}</span></td>
      <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${n.title || 'â€”'}</td>
      <td>${n.pair || 'â€”'}</td>
      <td>${n.delivered ? 'âœ…' : 'âŒ'}</td>
    </tr>`;
  }).join('');
}

// â”€â”€ Reglas de alerta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const CHECK_LABELS = { signal_drought:'SequÃ­a seÃ±ales', drawdown:'Drawdown', low_winrate:'Win rate bajo', stale_data:'Datos obsoletos', stale_models:'Modelos obsoletos' };
const SEV_COLORS = { info:'#8888ff', warning:'#ffa500', high:'#ff5050', critical:'#ff2222' };

async function loadAlertRules() {
  try {
    const r = await fetch('/api/alert-rules').then(r => r.json());
    const rules = r.rules || [];
    document.getElementById('rules-count').textContent = `${rules.length} regla(s) configuradas`;
    const list = document.getElementById('rules-list');
    if (!rules.length) {
      list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)"><div style="font-size:36px;margin-bottom:8px">âš™ï¸</div>Sin reglas configuradas. Crea una para recibir alertas automÃ¡ticas.</div>';
      return;
    }
    list.innerHTML = rules.map(rule => `
      <div class="rule-card" data-id="${rule.id}">
        <button class="rule-toggle ${rule.enabled?'on':''}" onclick="toggleRule('${rule.id}',${!rule.enabled})"></button>
        <div class="rule-info">
          <div class="rule-name">${rule.name}</div>
          <div class="rule-desc">${rule.description || CHECK_LABELS[rule.check_type] || rule.check_type}</div>
          <div class="rule-meta">
            <span>ğŸ¯ Umbral: <b>${rule.threshold} ${rule.unit}</b></span>
            <span>ğŸ’± Par: <b>${rule.pair || 'Todos'}</b></span>
            <span style="color:${SEV_COLORS[rule.severity]||'#888'}">âš ï¸ <b>${rule.severity}</b></span>
            <span>â±ï¸ Cooldown: <b>${rule.cooldown_hours}h</b></span>
          </div>
        </div>
        <div class="rule-actions">
          <button onclick="testRule('${rule.id}',this)" title="Enviar test a Telegram">ğŸ”” Test</button>
          <button class="del" onclick="deleteRule('${rule.id}')" title="Eliminar">ğŸ—‘ï¸</button>
        </div>
      </div>
    `).join('');
  } catch(e) {
    document.getElementById('rules-list').innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">Error cargando reglas</div>';
  }
}

async function toggleRule(id, enabled) {
  try {
    await fetch('/api/alert-rules', { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, enabled}) });
    loadAlertRules();
  } catch(e) { alert('Error actualizando regla'); }
}

async function testRule(id, btn) {
  if (!btn) btn = event.target;
  btn.disabled = true; btn.textContent = 'â³';
  try {
    const r = await fetch(`/api/alert-rules/test/${id}`, {method:'POST'}).then(r=>r.json());
    btn.textContent = r.ok ? 'âœ…' : 'âŒ';
    setTimeout(() => { btn.textContent = 'ğŸ”” Test'; btn.disabled = false; }, 2000);
  } catch(e) {
    btn.textContent = 'âŒ'; setTimeout(() => { btn.textContent = 'ğŸ”” Test'; btn.disabled = false; }, 2000);
  }
}

async function deleteRule(id) {
  if (!confirm('Â¿Eliminar esta regla de alerta?')) return;
  try {
    await fetch(`/api/alert-rules/${id}`, {method:'DELETE'});
    loadAlertRules();
  } catch(e) { alert('Error eliminando regla'); }
}

function toggleAddRule() {
  const form = document.getElementById('add-rule-form');
  form.classList.toggle('show');
}

async function saveNewRule() {
  const name = document.getElementById('ar-name').value.trim();
  if (!name) { alert('Nombre obligatorio'); return; }
  const body = {
    name,
    check_type: document.getElementById('ar-type').value,
    pair: document.getElementById('ar-pair').value || null,
    threshold: parseFloat(document.getElementById('ar-threshold').value),
    unit: document.getElementById('ar-unit').value,
    severity: document.getElementById('ar-severity').value,
    cooldown_hours: parseInt(document.getElementById('ar-cooldown').value),
  };
  try {
    const r = await fetch('/api/alert-rules', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) }).then(r=>r.json());
    if (r.ok) {
      document.getElementById('add-rule-form').classList.remove('show');
      document.getElementById('ar-name').value = '';
      loadAlertRules();
    } else {
      alert('Error creando regla');
    }
  } catch(e) { alert('Error: ' + e.message); }
}

// â”€â”€ Comparador de Modelos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _modelsData = null;

async function loadModels() {
  const grid = document.getElementById('models-grid');
  const summary = document.getElementById('models-summary');
  grid.innerHTML = '<div class="card" style="text-align:center;padding:40px;grid-column:1/-1"><div style="color:var(--muted)">Cargando modelosâ€¦</div></div>';
  summary.innerHTML = '';

  try {
    const resp = await fetch('/api/models/compare');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    _modelsData = await resp.json();

    // Populate filters
    const pairSel = document.getElementById('models-pair-filter');
    const tfSel = document.getElementById('models-tf-filter');
    const currentPair = pairSel.value;
    const currentTf = tfSel.value;

    pairSel.innerHTML = '<option value="all">Todos los pares</option>' +
      (_modelsData.pairs || []).map(p => `<option value="${p}">${p}</option>`).join('');
    tfSel.innerHTML = '<option value="all">Todos los TF</option>' +
      (_modelsData.timeframes || []).map(t => `<option value="${t}">${t}</option>`).join('');

    if (currentPair !== 'all') pairSel.value = currentPair;
    if (currentTf !== 'all') tfSel.value = currentTf;

    renderModels();
  } catch (e) {
    grid.innerHTML = `<div class="card" style="text-align:center;padding:40px;grid-column:1/-1">
      <div style="color:var(--red)">âš ï¸ Error cargando modelos: ${e.message}</div>
      <div style="color:var(--muted);font-size:12px;margin-top:8px">AsegÃºrate de que hay modelos en models/saved/</div>
    </div>`;
  }
}

function renderModels() {
  if (!_modelsData) return;
  const grid = document.getElementById('models-grid');
  const summaryEl = document.getElementById('models-summary');
  const pairFilter = document.getElementById('models-pair-filter').value;
  const tfFilter = document.getElementById('models-tf-filter').value;

  let models = _modelsData.models || [];
  if (pairFilter !== 'all') models = models.filter(m => m.pair === pairFilter);
  if (tfFilter !== 'all') models = models.filter(m => m.timeframe === tfFilter);

  // Summary cards
  const s = _modelsData.summary || {};
  summaryEl.innerHTML = `
    <div class="ms-card"><div class="ms-val">${s.total || 0}</div><div class="ms-label">Par/TF</div></div>
    <div class="ms-card"><div class="ms-val" style="color:var(--blue)">${s.xgb_wins || 0}</div><div class="ms-label">XGB gana</div></div>
    <div class="ms-card"><div class="ms-val" style="color:var(--purple)">${s.lstm_wins || 0}</div><div class="ms-label">LSTM gana</div></div>
    <div class="ms-card"><div class="ms-val" style="color:var(--muted)">${s.ties || 0}</div><div class="ms-label">Empates</div></div>
    <div class="ms-card"><div class="ms-val" style="color:var(--blue)">${(s.avg_xgb_f1||0).toFixed(4)}</div><div class="ms-label">F1 medio XGB</div></div>
    <div class="ms-card"><div class="ms-val" style="color:var(--purple)">${(s.avg_lstm_f1||0).toFixed(4)}</div><div class="ms-label">F1 medio LSTM</div></div>
  `;

  if (models.length === 0) {
    grid.innerHTML = '<div class="card" style="text-align:center;padding:40px;grid-column:1/-1"><div style="color:var(--muted)">Sin modelos entrenados aÃºn. Ejecuta el entrenamiento primero.</div></div>';
    return;
  }

  grid.innerHTML = models.map(m => {
    const xgb = m.xgb;
    const lstm = m.lstm;
    const xF1 = xgb ? xgb.f1 : 0;
    const lF1 = lstm ? lstm.f1 : 0;
    const maxF1 = Math.max(xF1, lF1, 0.001);

    function side(data, type, f1) {
      if (!data) return `<div class="model-side ${type}"><div class="model-side-title">${type === 'xgb' ? 'ğŸŒ² XGBoost' : 'ğŸ§  LSTM'}</div><div class="model-no-data">No entrenado</div></div>`;
      const isWinner = m.winner === type;
      const winCls = isWinner ? ' winner' : '';
      const trainDate = data.trained_at ? data.trained_at.replace('_', ' ') : 'â€”';

      let metricsHtml = '';
      if (type === 'xgb') {
        metricsHtml = `
          <div class="model-metric"><span class="mk">F1 (CV)</span><span class="mv${winCls}">${f1.toFixed(4)}</span></div>
          <div class="model-metric"><span class="mk">F1 std</span><span class="mv">${(data.f1_std||0).toFixed(4)}</span></div>
          <div class="model-metric"><span class="mk">Folds</span><span class="mv">${(data.f1_folds||[]).length}</span></div>
        `;
      } else {
        metricsHtml = `
          <div class="model-metric"><span class="mk">F1 (val)</span><span class="mv${winCls}">${f1.toFixed(4)}</span></div>
          <div class="model-metric"><span class="mk">Hidden</span><span class="mv">${data.hidden_size||'â€”'}</span></div>
          <div class="model-metric"><span class="mk">Layers</span><span class="mv">${data.num_layers||'â€”'}</span></div>
        `;
      }

      return `
        <div class="model-side ${type}">
          <div class="model-side-title">${type === 'xgb' ? 'ğŸŒ² XGBoost' : 'ğŸ§  LSTM'}${isWinner ? ' â­' : ''}</div>
          ${metricsHtml}
          <div class="model-metric"><span class="mk">Features</span><span class="mv">${data.n_features||'â€”'}</span></div>
          <div class="model-metric"><span class="mk">TamaÃ±o</span><span class="mv">${data.size_kb ? data.size_kb + ' KB' : 'â€”'}</span></div>
          <div class="model-metric"><span class="mk">Entrenado</span><span class="mv" style="font-size:11px">${trainDate}</span></div>
          <div class="f1-bar-wrap"><div class="f1-bar ${type}" style="width:${(f1/maxF1*100).toFixed(1)}%"></div></div>
        </div>`;
    }

    return `
      <div class="model-card">
        <div class="model-card-header">
          <span class="model-pair">${m.pair}</span>
          <span class="model-tf">${m.timeframe}</span>
        </div>
        <div class="model-vs">
          ${side(xgb, 'xgb', xF1)}
          ${side(lstm, 'lstm', lF1)}
        </div>
      </div>`;
  }).join('');
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadDashboard();
setInterval(loadDashboard, 30000);
</script>
</body>
</html>
